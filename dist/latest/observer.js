/**
 * Apache License
 * Version 2.0, January 2004
 * https://www.apache.org/licenses/
 *
 * TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION
 *
 * 1. Definitions.
 *
 * "License" shall mean the terms and conditions for use, reproduction,
 * and distribution as defined by Sections 1 through 9 of this document.
 *
 * "Licensor" shall mean the copyright owner or entity authorized by
 * the copyright owner that is granting the License.
 *
 * "Legal Entity" shall mean the union of the acting entity and all
 * other entities that control, are controlled by, or are under common
 * control with that entity. For the purposes of this definition,
 * "control" means (i) the power, direct or indirect, to cause the
 * direction or management of such entity, whether by contract or
 * otherwise, or (ii) ownership of fifty percent (50%) or more of the
 * outstanding shares, or (iii) beneficial ownership of such entity.
 *
 * "You" (or "Your") shall mean an individual or Legal Entity
 * exercising permissions granted by this License.
 *
 * "Source" form shall mean the preferred form for making modifications,
 * including but not limited to software source code, documentation
 * source, and configuration files.
 *
 * "Object" form shall mean any form resulting from mechanical
 * transformation or translation of a Source form, including but
 * not limited to compiled object code, generated documentation,
 * and conversions to other media types.
 *
 * "Work" shall mean the work of authorship, whether in Source or
 * Object form, made available under the License, as indicated by a
 * copyright notice that is included in or attached to the work
 * (an example is provided in the Appendix below).
 *
 * "Derivative Works" shall mean any work, whether in Source or Object
 * form, that is based on (or derived from) the Work and for which the
 * editorial revisions, annotations, elaborations, or other modifications
 * represent, as a whole, an original work of authorship. For the purposes
 * of this License, Derivative Works shall not include works that remain
 * separable from, or merely link (or bind by name) to the interfaces of,
 * the Work and Derivative Works thereof.
 *
 * "Contribution" shall mean any work of authorship, including
 * the original version of the Work and any modifications or additions
 * to that Work or Derivative Works thereof, that is intentionally
 * submitted to Licensor for inclusion in the Work by the copyright owner
 * or by an individual or Legal Entity authorized to submit on behalf of
 * the copyright owner. For the purposes of this definition, "submitted"
 * means any form of electronic, verbal, or written communication sent
 * to the Licensor or its representatives, including but not limited to
 * communication on electronic mailing lists, source code control systems,
 * and issue tracking systems that are managed by, or on behalf of, the
 * Licensor for the purpose of discussing and improving the Work, but
 * excluding communication that is conspicuously marked or otherwise
 * designated in writing by the copyright owner as "Not a Contribution."
 *
 * "Contributor" shall mean Licensor and any individual or Legal Entity
 * on behalf of whom a Contribution has been received by Licensor and
 * subsequently incorporated within the Work.
 *
 * 2. Grant of Copyright License. Subject to the terms and conditions of
 * this License, each Contributor hereby grants to You a perpetual,
 * worldwide, non-exclusive, no-charge, royalty-free, irrevocable
 * copyright license to reproduce, prepare Derivative Works of,
 * publicly display, publicly perform, sublicense, and distribute the
 * Work and such Derivative Works in Source or Object form.
 *
 * 3. Grant of Patent License. Subject to the terms and conditions of
 * this License, each Contributor hereby grants to You a perpetual,
 * worldwide, non-exclusive, no-charge, royalty-free, irrevocable
 * (except as stated in this section) patent license to make, have made,
 * use, offer to sell, sell, import, and otherwise transfer the Work,
 * where such license applies only to those patent claims licensable
 * by such Contributor that are necessarily infringed by their
 * Contribution(s) alone or by combination of their Contribution(s)
 * with the Work to which such Contribution(s) was submitted. If You
 * institute patent litigation against any entity (including a
 * cross-claim or counterclaim in a lawsuit) alleging that the Work
 * or a Contribution incorporated within the Work constitutes direct
 * or contributory patent infringement, then any patent licenses
 * granted to You under this License for that Work shall terminate
 * as of the date such litigation is filed.
 *
 * 4. Redistribution. You may reproduce and distribute copies of the
 * Work or Derivative Works thereof in any medium, with or without
 * modifications, and in Source or Object form, provided that You
 * meet the following conditions:
 *
 * (a) You must give any other recipients of the Work or
 * Derivative Works a copy of this License; and
 *
 * (b) You must cause any modified files to carry prominent notices
 * stating that You changed the files; and
 *
 * (c) You must retain, in the Source form of any Derivative Works
 * that You distribute, all copyright, patent, trademark, and
 * attribution notices from the Source form of the Work,
 * excluding those notices that do not pertain to any part of
 * the Derivative Works; and
 *
 * (d) If the Work includes a "NOTICE" text file as part of its
 * distribution, then any Derivative Works that You distribute must
 * include a readable copy of the attribution notices contained
 * within such NOTICE file, excluding those notices that do not
 * pertain to any part of the Derivative Works, in at least one
 * of the following places: within a NOTICE text file distributed
 * as part of the Derivative Works; within the Source form or
 * documentation, if provided along with the Derivative Works; or,
 * within a display generated by the Derivative Works, if and
 * wherever such third-party notices normally appear. The contents
 * of the NOTICE file are for informational purposes only and
 * do not modify the License. You may add Your own attribution
 * notices within Derivative Works that You distribute, alongside
 * or as an addendum to the NOTICE text from the Work, provided
 * that such additional attribution notices cannot be construed
 * as modifying the License.
 *
 * You may add Your own copyright statement to Your modifications and
 * may provide additional or different license terms and conditions
 * for use, reproduction, or distribution of Your modifications, or
 * for any such Derivative Works as a whole, provided Your use,
 * reproduction, and distribution of the Work otherwise complies with
 * the conditions stated in this License.
 *
 * 5. Submission of Contributions. Unless You explicitly state otherwise,
 * any Contribution intentionally submitted for inclusion in the Work
 * by You to the Licensor shall be under the terms and conditions of
 * this License, without any additional terms or conditions.
 * Notwithstanding the above, nothing herein shall supersede or modify
 * the terms of any separate license agreement you may have executed
 * with Licensor regarding such Contributions.
 *
 * 6. Trademarks. This License does not grant permission to use the trade
 * names, trademarks, service marks, or product names of the Licensor,
 * except as required for reasonable and customary use in describing the
 * origin of the Work and reproducing the content of the NOTICE file.
 *
 * 7. Disclaimer of Warranty. Unless required by applicable law or
 * agreed to in writing, Licensor provides the Work (and each
 * Contributor provides its Contributions) on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
 * implied, including, without limitation, any warranties or conditions
 * of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A
 * PARTICULAR PURPOSE. You are solely responsible for determining the
 * appropriateness of using or redistributing the Work and assume any
 * risks associated with Your exercise of permissions under this License.
 *
 * 8. Limitation of Liability. In no event and under no legal theory,
 * whether in tort (including negligence), contract, or otherwise,
 * unless required by applicable law (such as deliberate and grossly
 * negligent acts) or agreed to in writing, shall any Contributor be
 * liable to You for damages, including any direct, indirect, special,
 * incidental, or consequential damages of any character arising as a
 * result of this License or out of the use or inability to use the
 * Work (including but not limited to damages for loss of goodwill,
 * work stoppage, computer failure or malfunction, or any and all
 * other commercial damages or losses), even if such Contributor
 * has been advised of the possibility of such damages.
 *
 * 9. Accepting Warranty or Additional Liability. While redistributing
 * the Work or Derivative Works thereof, You may choose to offer,
 * and charge a fee for, acceptance of support, warranty, indemnity,
 * or other liability obligations and/or rights consistent with this
 * License. However, in accepting such obligations, You may act only
 * on Your own behalf and on Your sole responsibility, not on behalf
 * of any other Contributor, and only if You agree to indemnify,
 * defend, and hold each Contributor harmless for any liability
 * incurred by, or claims asserted against, such Contributor by reason
 * of your accepting any such warranty or additional liability.
 *
 * END OF TERMS AND CONDITIONS
 *
 * Copyright 2013-2018 Docker, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

(function (global, factory) {
	typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports) :
	typeof define === 'function' && define.amd ? define(['exports'], factory) :
	(global = typeof globalThis !== 'undefined' ? globalThis : global || self, factory(global.ObserverRTC = {}));
}(this, (function (exports) { 'use strict';

	var commonjsGlobal = typeof globalThis !== 'undefined' ? globalThis : typeof window !== 'undefined' ? window : typeof global !== 'undefined' ? global : typeof self !== 'undefined' ? self : {};

	function createCommonjsModule(fn, basedir, module) {
		return module = {
			path: basedir,
			exports: {},
			require: function (path, base) {
				return commonjsRequire(path, (base === undefined || base === null) ? module.path : base);
			}
		}, fn(module, module.exports), module.exports;
	}

	function commonjsRequire () {
		throw new Error('Dynamic requires are not currently supported by @rollup/plugin-commonjs');
	}

	var loglevel = createCommonjsModule(function (module) {
	/*
	* loglevel - https://github.com/pimterry/loglevel
	*
	* Copyright (c) 2013 Tim Perry
	* Licensed under the MIT license.
	*/
	(function (root, definition) {
	    if ( module.exports) {
	        module.exports = definition();
	    } else {
	        root.log = definition();
	    }
	}(commonjsGlobal, function () {

	    // Slightly dubious tricks to cut down minimized file size
	    var noop = function() {};
	    var undefinedType = "undefined";
	    var isIE = (typeof window !== undefinedType) && (typeof window.navigator !== undefinedType) && (
	        /Trident\/|MSIE /.test(window.navigator.userAgent)
	    );

	    var logMethods = [
	        "trace",
	        "debug",
	        "info",
	        "warn",
	        "error"
	    ];

	    // Cross-browser bind equivalent that works at least back to IE6
	    function bindMethod(obj, methodName) {
	        var method = obj[methodName];
	        if (typeof method.bind === 'function') {
	            return method.bind(obj);
	        } else {
	            try {
	                return Function.prototype.bind.call(method, obj);
	            } catch (e) {
	                // Missing bind shim or IE8 + Modernizr, fallback to wrapping
	                return function() {
	                    return Function.prototype.apply.apply(method, [obj, arguments]);
	                };
	            }
	        }
	    }

	    // Trace() doesn't print the message in IE, so for that case we need to wrap it
	    function traceForIE() {
	        if (console.log) {
	            if (console.log.apply) {
	                console.log.apply(console, arguments);
	            } else {
	                // In old IE, native console methods themselves don't have apply().
	                Function.prototype.apply.apply(console.log, [console, arguments]);
	            }
	        }
	        if (console.trace) console.trace();
	    }

	    // Build the best logging method possible for this env
	    // Wherever possible we want to bind, not wrap, to preserve stack traces
	    function realMethod(methodName) {
	        if (methodName === 'debug') {
	            methodName = 'log';
	        }

	        if (typeof console === undefinedType) {
	            return false; // No method possible, for now - fixed later by enableLoggingWhenConsoleArrives
	        } else if (methodName === 'trace' && isIE) {
	            return traceForIE;
	        } else if (console[methodName] !== undefined) {
	            return bindMethod(console, methodName);
	        } else if (console.log !== undefined) {
	            return bindMethod(console, 'log');
	        } else {
	            return noop;
	        }
	    }

	    // These private functions always need `this` to be set properly

	    function replaceLoggingMethods(level, loggerName) {
	        /*jshint validthis:true */
	        for (var i = 0; i < logMethods.length; i++) {
	            var methodName = logMethods[i];
	            this[methodName] = (i < level) ?
	                noop :
	                this.methodFactory(methodName, level, loggerName);
	        }

	        // Define log.log as an alias for log.debug
	        this.log = this.debug;
	    }

	    // In old IE versions, the console isn't present until you first open it.
	    // We build realMethod() replacements here that regenerate logging methods
	    function enableLoggingWhenConsoleArrives(methodName, level, loggerName) {
	        return function () {
	            if (typeof console !== undefinedType) {
	                replaceLoggingMethods.call(this, level, loggerName);
	                this[methodName].apply(this, arguments);
	            }
	        };
	    }

	    // By default, we use closely bound real methods wherever possible, and
	    // otherwise we wait for a console to appear, and then try again.
	    function defaultMethodFactory(methodName, level, loggerName) {
	        /*jshint validthis:true */
	        return realMethod(methodName) ||
	               enableLoggingWhenConsoleArrives.apply(this, arguments);
	    }

	    function Logger(name, defaultLevel, factory) {
	      var self = this;
	      var currentLevel;
	      var storageKey = "loglevel";
	      if (name) {
	        storageKey += ":" + name;
	      }

	      function persistLevelIfPossible(levelNum) {
	          var levelName = (logMethods[levelNum] || 'silent').toUpperCase();

	          if (typeof window === undefinedType) return;

	          // Use localStorage if available
	          try {
	              window.localStorage[storageKey] = levelName;
	              return;
	          } catch (ignore) {}

	          // Use session cookie as fallback
	          try {
	              window.document.cookie =
	                encodeURIComponent(storageKey) + "=" + levelName + ";";
	          } catch (ignore) {}
	      }

	      function getPersistedLevel() {
	          var storedLevel;

	          if (typeof window === undefinedType) return;

	          try {
	              storedLevel = window.localStorage[storageKey];
	          } catch (ignore) {}

	          // Fallback to cookies if local storage gives us nothing
	          if (typeof storedLevel === undefinedType) {
	              try {
	                  var cookie = window.document.cookie;
	                  var location = cookie.indexOf(
	                      encodeURIComponent(storageKey) + "=");
	                  if (location !== -1) {
	                      storedLevel = /^([^;]+)/.exec(cookie.slice(location))[1];
	                  }
	              } catch (ignore) {}
	          }

	          // If the stored level is not valid, treat it as if nothing was stored.
	          if (self.levels[storedLevel] === undefined) {
	              storedLevel = undefined;
	          }

	          return storedLevel;
	      }

	      /*
	       *
	       * Public logger API - see https://github.com/pimterry/loglevel for details
	       *
	       */

	      self.name = name;

	      self.levels = { "TRACE": 0, "DEBUG": 1, "INFO": 2, "WARN": 3,
	          "ERROR": 4, "SILENT": 5};

	      self.methodFactory = factory || defaultMethodFactory;

	      self.getLevel = function () {
	          return currentLevel;
	      };

	      self.setLevel = function (level, persist) {
	          if (typeof level === "string" && self.levels[level.toUpperCase()] !== undefined) {
	              level = self.levels[level.toUpperCase()];
	          }
	          if (typeof level === "number" && level >= 0 && level <= self.levels.SILENT) {
	              currentLevel = level;
	              if (persist !== false) {  // defaults to true
	                  persistLevelIfPossible(level);
	              }
	              replaceLoggingMethods.call(self, level, name);
	              if (typeof console === undefinedType && level < self.levels.SILENT) {
	                  return "No console available for logging";
	              }
	          } else {
	              throw "log.setLevel() called with invalid level: " + level;
	          }
	      };

	      self.setDefaultLevel = function (level) {
	          if (!getPersistedLevel()) {
	              self.setLevel(level, false);
	          }
	      };

	      self.enableAll = function(persist) {
	          self.setLevel(self.levels.TRACE, persist);
	      };

	      self.disableAll = function(persist) {
	          self.setLevel(self.levels.SILENT, persist);
	      };

	      // Initialize with the right level
	      var initialLevel = getPersistedLevel();
	      if (initialLevel == null) {
	          initialLevel = defaultLevel == null ? "WARN" : defaultLevel;
	      }
	      self.setLevel(initialLevel, false);
	    }

	    /*
	     *
	     * Top-level API
	     *
	     */

	    var defaultLogger = new Logger();

	    var _loggersByName = {};
	    defaultLogger.getLogger = function getLogger(name) {
	        if (typeof name !== "string" || name === "") {
	          throw new TypeError("You must supply a name when creating a logger.");
	        }

	        var logger = _loggersByName[name];
	        if (!logger) {
	          logger = _loggersByName[name] = new Logger(
	            name, defaultLogger.getLevel(), defaultLogger.methodFactory);
	        }
	        return logger;
	    };

	    // Grab the current global log variable in case of overwrite
	    var _log = (typeof window !== undefinedType) ? window.log : undefined;
	    defaultLogger.noConflict = function() {
	        if (typeof window !== undefinedType &&
	               window.log === defaultLogger) {
	            window.log = _log;
	        }

	        return defaultLogger;
	    };

	    defaultLogger.getLoggers = function getLoggers() {
	        return _loggersByName;
	    };

	    return defaultLogger;
	}));
	});

	// @ts-expect-error Will be injected in build time
	const isDebug = true === true;
	const initLogger = (prefix, dev = true) => {
	    // eslint-disable-next-line no-underscore-dangle
	    const _logger = loglevel.getLogger(prefix);
	    // eslint-disable-next-line @typescript-eslint/explicit-function-return-type
	    _logger.methodFactory = (methodName, logLevel, loggerName) => {
	        const originalFactory = loglevel.methodFactory, rawMethod = originalFactory(methodName, logLevel, loggerName);
	        // eslint-disable-next-line @typescript-eslint/explicit-function-return-type,func-names
	        return function () {
	            rawMethod(`${prefix} ${new Date().toUTCString()}`, 
	            // eslint-disable-next-line prefer-rest-params
	            ...arguments);
	        };
	    };
	    if (dev) {
	        _logger.enableAll();
	    }
	    else {
	        // eslint-disable-next-line @typescript-eslint/no-magic-numbers
	        _logger.setLevel(4);
	    }
	    return _logger;
	}, logger = initLogger('ObserverRTC', isDebug);

	// eslint-disable-next-line @typescript-eslint/no-extraneous-class
	class ParserUtil {
	    static parseWsServerUrl(serverURL, serviceUUID, mediaUnitId, statsVersion) {
	        if (!serverURL) {
	            throw Error('server url is undefined');
	        }
	        if (!serviceUUID) {
	            throw Error('service UUID is undefined');
	        }
	        if (!mediaUnitId) {
	            throw Error('media unit id is undefined');
	        }
	        if (!statsVersion) {
	            throw Error('stats version is undefined');
	        }
	        // eslint-disable-next-line no-param-reassign
	        serverURL = `${serverURL.replace(
        // eslint-disable-next-line require-unicode-regexp
        /\/$/, '')}`;
	        // eslint-disable-next-line no-param-reassign
	        serviceUUID = `${serviceUUID.replace(
        // eslint-disable-next-line require-unicode-regexp
        /^\//, '')}`;
	        // eslint-disable-next-line no-param-reassign
	        mediaUnitId = `${mediaUnitId.replace(
        // eslint-disable-next-line require-unicode-regexp
        /^\//, '')}`;
	        // eslint-disable-next-line no-param-reassign
	        statsVersion = `${statsVersion.replace(
        // eslint-disable-next-line require-unicode-regexp
        /^\//, '')}`;
	        return `${serverURL}/${serviceUUID}/${mediaUnitId}/${statsVersion}/json`;
	    }
	}

	/*! *****************************************************************************
	Copyright (c) Microsoft Corporation.

	Permission to use, copy, modify, and/or distribute this software for any
	purpose with or without fee is hereby granted.

	THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
	REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
	AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
	INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
	LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
	OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
	PERFORMANCE OF THIS SOFTWARE.
	***************************************************************************** */

	var __assign = function() {
	    __assign = Object.assign || function __assign(t) {
	        for (var s, i = 1, n = arguments.length; i < n; i++) {
	            s = arguments[i];
	            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];
	        }
	        return t;
	    };
	    return __assign.apply(this, arguments);
	};

	function __awaiter(thisArg, _arguments, P, generator) {
	    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
	    return new (P || (P = Promise))(function (resolve, reject) {
	        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
	        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
	        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
	        step((generator = generator.apply(thisArg, _arguments || [])).next());
	    });
	}

	function __generator(thisArg, body) {
	    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
	    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
	    function verb(n) { return function (v) { return step([n, v]); }; }
	    function step(op) {
	        if (f) throw new TypeError("Generator is already executing.");
	        while (_) try {
	            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
	            if (y = 0, t) op = [op[0] & 2, t.value];
	            switch (op[0]) {
	                case 0: case 1: t = op; break;
	                case 4: _.label++; return { value: op[1], done: false };
	                case 5: _.label++; y = op[1]; op = [0]; continue;
	                case 7: op = _.ops.pop(); _.trys.pop(); continue;
	                default:
	                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
	                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
	                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
	                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
	                    if (t[2]) _.ops.pop();
	                    _.trys.pop(); continue;
	            }
	            op = body.call(thisArg, _);
	        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
	        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
	    }
	}

	class UserMediaHandler {
	    overrideUserMedia(userMediaCallback) {
	        const origGetUserMedia = navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);
	        // eslint-disable-next-line @typescript-eslint/promise-function-async,@typescript-eslint/explicit-function-return-type,func-names
	        const newGetUserMedia = function () {
	            return origGetUserMedia.apply(navigator.mediaDevices, 
	            // @ts-expect-error ignore
	            // eslint-disable-next-line prefer-rest-params
	            arguments).then((stream) => __awaiter(this, void 0, void 0, function* () { return Promise.resolve(stream); }), (err) => __awaiter(this, void 0, void 0, function* () {
	                // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access
	                userMediaCallback.onMediaError(err.name);
	                return Promise.reject(err);
	            }));
	        };
	        navigator.mediaDevices.getUserMedia = newGetUserMedia.bind(navigator.mediaDevices);
	    }
	}

	class CollectorWorker {
	    constructor(loadURL, _clientCallback) {
	        this.loadURL = loadURL;
	        this._clientCallback = _clientCallback;
	        this.loadWorker = this.loadWorker.bind(this);
	    }
	    loadWorker() {
	        const contentURL = `importScripts( '${this.loadURL}' );`, workerURL = URL.createObjectURL(new Blob([contentURL], { 'type': 'text/javascript' }));
	        this._worker = new Worker(workerURL);
	        this._worker.onerror = this.onError.bind(this);
	        this._worker.onmessage = this.onMessage.bind(this);
	    }
	    sendInitialConfig(initializeConfig) {
	        const payload = {
	            'data': initializeConfig,
	            'what': 'onRequestInitialConfig'
	        };
	        this._worker.postMessage(payload);
	    }
	    sendUserMediaError(userMediaErrorPayload) {
	        const payload = {
	            'data': userMediaErrorPayload,
	            'what': 'onUserMediaError'
	        };
	        this._worker.postMessage(payload);
	    }
	    sendRawStats(rawStats) {
	        const payload = {
	            'data': rawStats,
	            'what': 'onRequestRawStats'
	        };
	        this._worker.postMessage(payload);
	    }
	    onError(err) {
	        var _a;
	        logger.error(err);
	        (_a = this._clientCallback) === null || _a === void 0 ? void 0 : _a.onError(err);
	    }
	    onMessage(msg) {
	        var _a, _b, _c;
	        const data = msg.data;
	        switch (data.what) {
	            case 'requestRawStats':
	                (_a = this._clientCallback) === null || _a === void 0 ? void 0 : _a.onRequestRawStats();
	                return;
	            case 'requestInitialConfig':
	                (_b = this._clientCallback) === null || _b === void 0 ? void 0 : _b.onRequestInitialConfig();
	                return;
	            case 'onLocalTransport':
	                (_c = this._clientCallback) === null || _c === void 0 ? void 0 : _c.onTransportCallback(data.data);
	                return;
	            default:
	                logger.warn('unknown types', data);
	        }
	    }
	}

	// Unique ID creation requires a high quality random # generator. In the browser we therefore
	// require the crypto API and do not support built-in fallback to lower quality random number
	// generators (like Math.random()).
	// getRandomValues needs to be invoked in a context where "this" is a Crypto implementation. Also,
	// find the complete implementation of crypto (msCrypto) on IE11.
	var getRandomValues = typeof crypto !== 'undefined' && crypto.getRandomValues && crypto.getRandomValues.bind(crypto) || typeof msCrypto !== 'undefined' && typeof msCrypto.getRandomValues === 'function' && msCrypto.getRandomValues.bind(msCrypto);
	var rnds8 = new Uint8Array(16);
	function rng() {
	  if (!getRandomValues) {
	    throw new Error('crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported');
	  }

	  return getRandomValues(rnds8);
	}

	/**
	 * Convert array of 16 byte values to UUID string format of the form:
	 * XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX
	 */
	var byteToHex = [];

	for (var i = 0; i < 256; ++i) {
	  byteToHex.push((i + 0x100).toString(16).substr(1));
	}

	function bytesToUuid(buf, offset) {
	  var i = offset || 0;
	  var bth = byteToHex; // Note: Be careful editing this code!  It's been tuned for performance
	  // and works in ways you may not expect. See https://github.com/uuidjs/uuid/pull/434

	  return (bth[buf[i + 0]] + bth[buf[i + 1]] + bth[buf[i + 2]] + bth[buf[i + 3]] + '-' + bth[buf[i + 4]] + bth[buf[i + 5]] + '-' + bth[buf[i + 6]] + bth[buf[i + 7]] + '-' + bth[buf[i + 8]] + bth[buf[i + 9]] + '-' + bth[buf[i + 10]] + bth[buf[i + 11]] + bth[buf[i + 12]] + bth[buf[i + 13]] + bth[buf[i + 14]] + bth[buf[i + 15]]).toLowerCase();
	}

	function v4(options, buf, offset) {
	  if (typeof options === 'string') {
	    buf = options === 'binary' ? new Uint8Array(16) : null;
	    options = null;
	  }

	  options = options || {};
	  var rnds = options.random || (options.rng || rng)(); // Per 4.4, set bits for version and `clock_seq_hi_and_reserved`

	  rnds[6] = rnds[6] & 0x0f | 0x40;
	  rnds[8] = rnds[8] & 0x3f | 0x80; // Copy bytes to buffer, if provided

	  if (buf) {
	    var start = offset || 0;

	    for (var i = 0; i < 16; ++i) {
	      buf[start + i] = rnds[i];
	    }

	    return buf;
	  }

	  return bytesToUuid(rnds);
	}

	/**
	 * FingerprintJS v3.0.3 - Copyright (c) FingerprintJS, Inc, 2020 (https://fingerprintjs.com)
	 * Licensed under the MIT (http://www.opensource.org/licenses/mit-license.php) license.
	 *
	 * This software contains code from open-source projects:
	 * MurmurHash3 by Karan Lyons (https://github.com/karanlyons/murmurHash3.js)
	 */

	/*
	 * Taken from https://github.com/karanlyons/murmurHash3.js/blob/a33d0723127e2e5415056c455f8aed2451ace208/murmurHash3.js
	 */
	//
	// Given two 64bit ints (as an array of two 32bit ints) returns the two
	// added together as a 64bit int (as an array of two 32bit ints).
	//
	function x64Add(m, n) {
	    m = [m[0] >>> 16, m[0] & 0xffff, m[1] >>> 16, m[1] & 0xffff];
	    n = [n[0] >>> 16, n[0] & 0xffff, n[1] >>> 16, n[1] & 0xffff];
	    var o = [0, 0, 0, 0];
	    o[3] += m[3] + n[3];
	    o[2] += o[3] >>> 16;
	    o[3] &= 0xffff;
	    o[2] += m[2] + n[2];
	    o[1] += o[2] >>> 16;
	    o[2] &= 0xffff;
	    o[1] += m[1] + n[1];
	    o[0] += o[1] >>> 16;
	    o[1] &= 0xffff;
	    o[0] += m[0] + n[0];
	    o[0] &= 0xffff;
	    return [(o[0] << 16) | o[1], (o[2] << 16) | o[3]];
	}
	//
	// Given two 64bit ints (as an array of two 32bit ints) returns the two
	// multiplied together as a 64bit int (as an array of two 32bit ints).
	//
	function x64Multiply(m, n) {
	    m = [m[0] >>> 16, m[0] & 0xffff, m[1] >>> 16, m[1] & 0xffff];
	    n = [n[0] >>> 16, n[0] & 0xffff, n[1] >>> 16, n[1] & 0xffff];
	    var o = [0, 0, 0, 0];
	    o[3] += m[3] * n[3];
	    o[2] += o[3] >>> 16;
	    o[3] &= 0xffff;
	    o[2] += m[2] * n[3];
	    o[1] += o[2] >>> 16;
	    o[2] &= 0xffff;
	    o[2] += m[3] * n[2];
	    o[1] += o[2] >>> 16;
	    o[2] &= 0xffff;
	    o[1] += m[1] * n[3];
	    o[0] += o[1] >>> 16;
	    o[1] &= 0xffff;
	    o[1] += m[2] * n[2];
	    o[0] += o[1] >>> 16;
	    o[1] &= 0xffff;
	    o[1] += m[3] * n[1];
	    o[0] += o[1] >>> 16;
	    o[1] &= 0xffff;
	    o[0] += m[0] * n[3] + m[1] * n[2] + m[2] * n[1] + m[3] * n[0];
	    o[0] &= 0xffff;
	    return [(o[0] << 16) | o[1], (o[2] << 16) | o[3]];
	}
	//
	// Given a 64bit int (as an array of two 32bit ints) and an int
	// representing a number of bit positions, returns the 64bit int (as an
	// array of two 32bit ints) rotated left by that number of positions.
	//
	function x64Rotl(m, n) {
	    n %= 64;
	    if (n === 32) {
	        return [m[1], m[0]];
	    }
	    else if (n < 32) {
	        return [(m[0] << n) | (m[1] >>> (32 - n)), (m[1] << n) | (m[0] >>> (32 - n))];
	    }
	    else {
	        n -= 32;
	        return [(m[1] << n) | (m[0] >>> (32 - n)), (m[0] << n) | (m[1] >>> (32 - n))];
	    }
	}
	//
	// Given a 64bit int (as an array of two 32bit ints) and an int
	// representing a number of bit positions, returns the 64bit int (as an
	// array of two 32bit ints) shifted left by that number of positions.
	//
	function x64LeftShift(m, n) {
	    n %= 64;
	    if (n === 0) {
	        return m;
	    }
	    else if (n < 32) {
	        return [(m[0] << n) | (m[1] >>> (32 - n)), m[1] << n];
	    }
	    else {
	        return [m[1] << (n - 32), 0];
	    }
	}
	//
	// Given two 64bit ints (as an array of two 32bit ints) returns the two
	// xored together as a 64bit int (as an array of two 32bit ints).
	//
	function x64Xor(m, n) {
	    return [m[0] ^ n[0], m[1] ^ n[1]];
	}
	//
	// Given a block, returns murmurHash3's final x64 mix of that block.
	// (`[0, h[0] >>> 1]` is a 33 bit unsigned right shift. This is the
	// only place where we need to right shift 64bit ints.)
	//
	function x64Fmix(h) {
	    h = x64Xor(h, [0, h[0] >>> 1]);
	    h = x64Multiply(h, [0xff51afd7, 0xed558ccd]);
	    h = x64Xor(h, [0, h[0] >>> 1]);
	    h = x64Multiply(h, [0xc4ceb9fe, 0x1a85ec53]);
	    h = x64Xor(h, [0, h[0] >>> 1]);
	    return h;
	}
	//
	// Given a string and an optional seed as an int, returns a 128 bit
	// hash using the x64 flavor of MurmurHash3, as an unsigned hex.
	//
	function x64hash128(key, seed) {
	    key = key || '';
	    seed = seed || 0;
	    var remainder = key.length % 16;
	    var bytes = key.length - remainder;
	    var h1 = [0, seed];
	    var h2 = [0, seed];
	    var k1 = [0, 0];
	    var k2 = [0, 0];
	    var c1 = [0x87c37b91, 0x114253d5];
	    var c2 = [0x4cf5ad43, 0x2745937f];
	    var i;
	    for (i = 0; i < bytes; i = i + 16) {
	        k1 = [
	            (key.charCodeAt(i + 4) & 0xff) |
	                ((key.charCodeAt(i + 5) & 0xff) << 8) |
	                ((key.charCodeAt(i + 6) & 0xff) << 16) |
	                ((key.charCodeAt(i + 7) & 0xff) << 24),
	            (key.charCodeAt(i) & 0xff) |
	                ((key.charCodeAt(i + 1) & 0xff) << 8) |
	                ((key.charCodeAt(i + 2) & 0xff) << 16) |
	                ((key.charCodeAt(i + 3) & 0xff) << 24),
	        ];
	        k2 = [
	            (key.charCodeAt(i + 12) & 0xff) |
	                ((key.charCodeAt(i + 13) & 0xff) << 8) |
	                ((key.charCodeAt(i + 14) & 0xff) << 16) |
	                ((key.charCodeAt(i + 15) & 0xff) << 24),
	            (key.charCodeAt(i + 8) & 0xff) |
	                ((key.charCodeAt(i + 9) & 0xff) << 8) |
	                ((key.charCodeAt(i + 10) & 0xff) << 16) |
	                ((key.charCodeAt(i + 11) & 0xff) << 24),
	        ];
	        k1 = x64Multiply(k1, c1);
	        k1 = x64Rotl(k1, 31);
	        k1 = x64Multiply(k1, c2);
	        h1 = x64Xor(h1, k1);
	        h1 = x64Rotl(h1, 27);
	        h1 = x64Add(h1, h2);
	        h1 = x64Add(x64Multiply(h1, [0, 5]), [0, 0x52dce729]);
	        k2 = x64Multiply(k2, c2);
	        k2 = x64Rotl(k2, 33);
	        k2 = x64Multiply(k2, c1);
	        h2 = x64Xor(h2, k2);
	        h2 = x64Rotl(h2, 31);
	        h2 = x64Add(h2, h1);
	        h2 = x64Add(x64Multiply(h2, [0, 5]), [0, 0x38495ab5]);
	    }
	    k1 = [0, 0];
	    k2 = [0, 0];
	    switch (remainder) {
	        case 15:
	            k2 = x64Xor(k2, x64LeftShift([0, key.charCodeAt(i + 14)], 48));
	        // fallthrough
	        case 14:
	            k2 = x64Xor(k2, x64LeftShift([0, key.charCodeAt(i + 13)], 40));
	        // fallthrough
	        case 13:
	            k2 = x64Xor(k2, x64LeftShift([0, key.charCodeAt(i + 12)], 32));
	        // fallthrough
	        case 12:
	            k2 = x64Xor(k2, x64LeftShift([0, key.charCodeAt(i + 11)], 24));
	        // fallthrough
	        case 11:
	            k2 = x64Xor(k2, x64LeftShift([0, key.charCodeAt(i + 10)], 16));
	        // fallthrough
	        case 10:
	            k2 = x64Xor(k2, x64LeftShift([0, key.charCodeAt(i + 9)], 8));
	        // fallthrough
	        case 9:
	            k2 = x64Xor(k2, [0, key.charCodeAt(i + 8)]);
	            k2 = x64Multiply(k2, c2);
	            k2 = x64Rotl(k2, 33);
	            k2 = x64Multiply(k2, c1);
	            h2 = x64Xor(h2, k2);
	        // fallthrough
	        case 8:
	            k1 = x64Xor(k1, x64LeftShift([0, key.charCodeAt(i + 7)], 56));
	        // fallthrough
	        case 7:
	            k1 = x64Xor(k1, x64LeftShift([0, key.charCodeAt(i + 6)], 48));
	        // fallthrough
	        case 6:
	            k1 = x64Xor(k1, x64LeftShift([0, key.charCodeAt(i + 5)], 40));
	        // fallthrough
	        case 5:
	            k1 = x64Xor(k1, x64LeftShift([0, key.charCodeAt(i + 4)], 32));
	        // fallthrough
	        case 4:
	            k1 = x64Xor(k1, x64LeftShift([0, key.charCodeAt(i + 3)], 24));
	        // fallthrough
	        case 3:
	            k1 = x64Xor(k1, x64LeftShift([0, key.charCodeAt(i + 2)], 16));
	        // fallthrough
	        case 2:
	            k1 = x64Xor(k1, x64LeftShift([0, key.charCodeAt(i + 1)], 8));
	        // fallthrough
	        case 1:
	            k1 = x64Xor(k1, [0, key.charCodeAt(i)]);
	            k1 = x64Multiply(k1, c1);
	            k1 = x64Rotl(k1, 31);
	            k1 = x64Multiply(k1, c2);
	            h1 = x64Xor(h1, k1);
	        // fallthrough
	    }
	    h1 = x64Xor(h1, [0, key.length]);
	    h2 = x64Xor(h2, [0, key.length]);
	    h1 = x64Add(h1, h2);
	    h2 = x64Add(h2, h1);
	    h1 = x64Fmix(h1);
	    h2 = x64Fmix(h2);
	    h1 = x64Add(h1, h2);
	    h2 = x64Add(h2, h1);
	    return (('00000000' + (h1[0] >>> 0).toString(16)).slice(-8) +
	        ('00000000' + (h1[1] >>> 0).toString(16)).slice(-8) +
	        ('00000000' + (h2[0] >>> 0).toString(16)).slice(-8) +
	        ('00000000' + (h2[1] >>> 0).toString(16)).slice(-8));
	}

	var version = "3.0.3";

	var w = window;
	function requestIdleCallbackIfAvailable(fallbackTimeout, deadlineTimeout) {
	    if (deadlineTimeout === void 0) { deadlineTimeout = Infinity; }
	    return new Promise(function (resolve) {
	        if (w.requestIdleCallback) {
	            w.requestIdleCallback(function () { return resolve(); }, { timeout: deadlineTimeout });
	        }
	        else {
	            setTimeout(resolve, Math.min(fallbackTimeout, deadlineTimeout));
	        }
	    });
	}

	/**
	 * Converts an error object to a plain object that can be used with `JSON.stringify`.
	 * If you just run `JSON.stringify(error)`, you'll get `'{}'`.
	 */
	function errorToObject(error) {
	    var _a;
	    return __assign({ name: error.name, message: error.message, stack: (_a = error.stack) === null || _a === void 0 ? void 0 : _a.split('\n') }, error);
	}

	/*
	 * This file contains functions to work with pure data only (no browser features, DOM, side effects, etc).
	 */
	/**
	 * Does the same as Array.prototype.includes but has better typing
	 */
	function includes(haystack, needle) {
	    for (var i = 0, l = haystack.length; i < l; ++i) {
	        if (haystack[i] === needle) {
	            return true;
	        }
	    }
	    return false;
	}
	/**
	 * Like `!includes()` but with proper typing
	 */
	function excludes(haystack, needle) {
	    return !includes(haystack, needle);
	}
	/**
	 * Be careful, NaN can return
	 */
	function toInt(value) {
	    return parseInt(value);
	}
	/**
	 * Be careful, NaN can return
	 */
	function toFloat(value) {
	    return parseFloat(value);
	}
	function replaceNaN(value, replacement) {
	    return typeof value === 'number' && isNaN(value) ? replacement : value;
	}
	function countTruthy(values) {
	    return values.reduce(function (sum, value) { return sum + (value ? 1 : 0); }, 0);
	}

	/*
	 * Functions to help with features that vary through browsers
	 */
	var w$1 = window;
	var n = navigator;
	/**
	 * Checks whether the browser is based on Trident (the Internet Explorer engine) without using user-agent.
	 *
	 * Warning for package users:
	 * This function is out of Semantic Versioning, i.e. can change unexpectedly. Usage is at your own risk.
	 */
	function isTrident() {
	    // The properties are checked to be in IE 10, IE 11 and not to be in other browsers in October 2020
	    return (countTruthy([
	        'MSCSSMatrix' in w$1,
	        'msSetImmediate' in w$1,
	        'msIndexedDB' in w$1,
	        'msMaxTouchPoints' in n,
	        'msPointerEnabled' in n,
	    ]) >= 4);
	}
	/**
	 * Checks whether the browser is based on EdgeHTML (the pre-Chromium Edge engine) without using user-agent.
	 *
	 * Warning for package users:
	 * This function is out of Semantic Versioning, i.e. can change unexpectedly. Usage is at your own risk.
	 */
	function isEdgeHTML() {
	    // Based on research in October 2020
	    return (countTruthy(['msWriteProfilerMark' in w$1, 'MSStream' in w$1, 'msLaunchUri' in n, 'msSaveBlob' in n]) >= 3 &&
	        !isTrident());
	}
	/**
	 * Checks whether the browser is based on Chromium without using user-agent.
	 *
	 * Warning for package users:
	 * This function is out of Semantic Versioning, i.e. can change unexpectedly. Usage is at your own risk.
	 */
	function isChromium() {
	    // Based on research in October 2020. Tested to detect Chromium 42-86.
	    return (countTruthy([
	        'webkitPersistentStorage' in n,
	        'webkitTemporaryStorage' in n,
	        n.vendor.indexOf('Google') === 0,
	        'webkitResolveLocalFileSystemURL' in w$1,
	        'BatteryManager' in w$1,
	        'webkitMediaStream' in w$1,
	        'webkitSpeechGrammar' in w$1,
	    ]) >= 5);
	}
	/**
	 * Checks whether the browser is based on mobile or desktop Safari without using user-agent.
	 * All iOS browsers use WebKit (the Safari engine).
	 *
	 * Warning for package users:
	 * This function is out of Semantic Versioning, i.e. can change unexpectedly. Usage is at your own risk.
	 */
	function isWebKit() {
	    // Based on research in September 2020
	    return (countTruthy([
	        'ApplePayError' in w$1,
	        'CSSPrimitiveValue' in w$1,
	        'Counter' in w$1,
	        n.vendor.indexOf('Apple') === 0,
	        'getStorageUpdates' in n,
	        'WebKitMediaKeys' in w$1,
	    ]) >= 4);
	}
	/**
	 * Checks whether the WebKit browser is a desktop Safari.
	 *
	 * Warning for package users:
	 * This function is out of Semantic Versioning, i.e. can change unexpectedly. Usage is at your own risk.
	 */
	function isDesktopSafari() {
	    return (countTruthy([
	        'safari' in w$1,
	        !('DeviceMotionEvent' in w$1),
	        !('ongestureend' in w$1),
	        !('standalone' in n),
	    ]) >= 3);
	}
	/**
	 * Checks whether the browser is based on Chromium version ≥86 without using user-agent.
	 * It doesn't check that the browser is based on Chromium, there is a separate function for this.
	 */
	function isChromium86OrNewer() {
	    // Checked in Chrome 85 vs Chrome 86 both on desktop and Android
	    return (countTruthy([
	        !('MediaSettingsRange' in w$1),
	        'RTCEncodedAudioFrame' in w$1,
	        '' + w$1.Intl === '[object Intl]',
	        '' + w$1.Reflect === '[object Reflect]',
	    ]) >= 3);
	}
	/**
	 * Checks whether the browser is based on WebKit version ≥606 (Safari ≥12) without using user-agent.
	 * It doesn't check that the browser is based on WebKit, there is a separate function for this.
	 *
	 * @link https://en.wikipedia.org/wiki/Safari_version_history#Release_history Safari-WebKit versions map
	 */
	function isWebKit606OrNewer() {
	    // Checked in Safari 9–14
	    return (countTruthy([
	        'DOMRectList' in w$1,
	        'RTCPeerConnectionIceEvent' in w$1,
	        'SVGGeometryElement' in w$1,
	        'ontransitioncancel' in w$1,
	    ]) >= 3);
	}

	var w$2 = window;
	var d$1 = document;
	// Inspired by and based on https://github.com/cozylife/audio-fingerprint
	function getAudioFingerprint() {
	    return __awaiter(this, void 0, void 0, function () {
	        var AudioContext, context, oscillator, compressor, buffer, error_1;
	        return __generator(this, function (_a) {
	            switch (_a.label) {
	                case 0:
	                    AudioContext = w$2.OfflineAudioContext || w$2.webkitOfflineAudioContext;
	                    if (!AudioContext) {
	                        return [2 /*return*/, -2 /* NotSupported */];
	                    }
	                    // In some browsers, audio context always stays suspended unless the context is started in response to a user action
	                    // (e.g. a click or a tap). It prevents audio fingerprint from being taken at an arbitrary moment of time.
	                    // Such browsers are old and unpopular, so the audio fingerprinting is just skipped in them.
	                    // See a similar case explanation at https://stackoverflow.com/questions/46363048/onaudioprocess-not-called-on-ios11#46534088
	                    if (doesCurrentBrowserSuspendAudioContext()) {
	                        return [2 /*return*/, -1 /* KnownToSuspend */];
	                    }
	                    context = new AudioContext(1, 44100, 44100);
	                    oscillator = context.createOscillator();
	                    oscillator.type = 'triangle';
	                    setAudioParam(context, oscillator.frequency, 10000);
	                    compressor = context.createDynamicsCompressor();
	                    setAudioParam(context, compressor.threshold, -50);
	                    setAudioParam(context, compressor.knee, 40);
	                    setAudioParam(context, compressor.ratio, 12);
	                    setAudioParam(context, compressor.reduction, -20);
	                    setAudioParam(context, compressor.attack, 0);
	                    setAudioParam(context, compressor.release, 0.25);
	                    oscillator.connect(compressor);
	                    compressor.connect(context.destination);
	                    oscillator.start(0);
	                    _a.label = 1;
	                case 1:
	                    _a.trys.push([1, 3, 4, 5]);
	                    return [4 /*yield*/, renderAudio(context)];
	                case 2:
	                    buffer = _a.sent();
	                    return [3 /*break*/, 5];
	                case 3:
	                    error_1 = _a.sent();
	                    if (error_1.name === "timeout" /* Timeout */ || error_1.name === "suspended" /* Suspended */) {
	                        return [2 /*return*/, -3 /* Timeout */];
	                    }
	                    throw error_1;
	                case 4:
	                    oscillator.disconnect();
	                    compressor.disconnect();
	                    return [7 /*endfinally*/];
	                case 5: return [2 /*return*/, getHash(buffer.getChannelData(0))];
	            }
	        });
	    });
	}
	/**
	 * Checks if the current browser is known to always suspend audio context
	 */
	function doesCurrentBrowserSuspendAudioContext() {
	    return isWebKit() && !isDesktopSafari() && !isWebKit606OrNewer();
	}
	function setAudioParam(context, param, value) {
	    var isAudioParam = function (value) {
	        return value && typeof value.setValueAtTime === 'function';
	    };
	    if (isAudioParam(param)) {
	        param.setValueAtTime(value, context.currentTime);
	    }
	}
	function renderAudio(context) {
	    var resumeTriesMaxCount = 3;
	    var resumeRetryDelay = 500;
	    var runningTimeout = 1000;
	    return new Promise(function (resolve, reject) {
	        context.oncomplete = function (event) { return resolve(event.renderedBuffer); };
	        var resumeTriesLeft = resumeTriesMaxCount;
	        var tryResume = function () {
	            context.startRendering();
	            switch (context.state) {
	                case 'running':
	                    setTimeout(function () { return reject(makeInnerError("timeout" /* Timeout */)); }, runningTimeout);
	                    break;
	                // Sometimes the audio context doesn't start after calling `startRendering` (in addition to the cases where
	                // audio context doesn't start at all). A known case is starting an audio context when the browser tab is in
	                // background on iPhone. Retries usually help in this case.
	                case 'suspended':
	                    // The audio context can reject starting until the tab is in foreground. Long fingerprint duration
	                    // in background isn't a problem, therefore the retry attempts don't count in background. It can lead to
	                    // a situation when a fingerprint takes very long time and finishes successfully. FYI, the audio context
	                    // can be suspended when `document.hidden === false` and start running after a retry.
	                    if (!d$1.hidden) {
	                        resumeTriesLeft--;
	                    }
	                    if (resumeTriesLeft > 0) {
	                        setTimeout(tryResume, resumeRetryDelay);
	                    }
	                    else {
	                        reject(makeInnerError("suspended" /* Suspended */));
	                    }
	                    break;
	            }
	        };
	        tryResume();
	    });
	}
	function getHash(signal) {
	    var hash = 0;
	    for (var i = 4500; i < 5000; ++i) {
	        hash += Math.abs(signal[i]);
	    }
	    return hash;
	}
	function makeInnerError(name) {
	    var error = new Error(name);
	    error.name = name;
	    return error;
	}

	var d$2 = document;
	// We use m or w because these two characters take up the maximum width.
	// And we use a LLi so that the same matching fonts can get separated.
	var testString = 'mmMwWLliI0O&1';
	// We test using 48px font size, we may use any size. I guess larger the better.
	var testSize = '48px';
	// A font will be compared against all the three default fonts.
	// And if it doesn't match all 3 then that font is not available.
	var baseFonts = ['monospace', 'sans-serif', 'serif'];
	var fontList = [
	    // This is android-specific font from "Roboto" family
	    'sans-serif-thin',
	    'ARNO PRO',
	    'Agency FB',
	    'Arabic Typesetting',
	    'Arial Unicode MS',
	    'AvantGarde Bk BT',
	    'BankGothic Md BT',
	    'Batang',
	    'Bitstream Vera Sans Mono',
	    'Calibri',
	    'Century',
	    'Century Gothic',
	    'Clarendon',
	    'EUROSTILE',
	    'Franklin Gothic',
	    'Futura Bk BT',
	    'Futura Md BT',
	    'GOTHAM',
	    'Gill Sans',
	    'HELV',
	    'Haettenschweiler',
	    'Helvetica Neue',
	    'Humanst521 BT',
	    'Leelawadee',
	    'Letter Gothic',
	    'Levenim MT',
	    'Lucida Bright',
	    'Lucida Sans',
	    'Menlo',
	    'MS Mincho',
	    'MS Outlook',
	    'MS Reference Specialty',
	    'MS UI Gothic',
	    'MT Extra',
	    'MYRIAD PRO',
	    'Marlett',
	    'Meiryo UI',
	    'Microsoft Uighur',
	    'Minion Pro',
	    'Monotype Corsiva',
	    'PMingLiU',
	    'Pristina',
	    'SCRIPTINA',
	    'Segoe UI Light',
	    'Serifa',
	    'SimHei',
	    'Small Fonts',
	    'Staccato222 BT',
	    'TRAJAN PRO',
	    'Univers CE 55 Medium',
	    'Vrinda',
	    'ZWAdobeF',
	];
	var fontSpanStyle = {
	    // CSS font reset to reset external styles
	    fontStyle: 'normal',
	    fontWeight: 'normal',
	    letterSpacing: 'normal',
	    lineBreak: 'auto',
	    lineHeight: 'normal',
	    textTransform: 'none',
	    textAlign: 'left',
	    textDecoration: 'none',
	    textShadow: 'none',
	    whiteSpace: 'normal',
	    wordBreak: 'normal',
	    wordSpacing: 'normal',
	    // We need this css as in some weird browser this span elements shows up for a microSec which creates
	    // a bad user experience
	    position: 'absolute',
	    left: '-9999px',
	    fontSize: testSize,
	};
	// kudos to http://www.lalit.org/lab/javascript-css-font-detect/
	function getFonts() {
	    var h = d$2.body;
	    // div to load spans for the base fonts
	    var baseFontsDiv = d$2.createElement('div');
	    // div to load spans for the fonts to detect
	    var fontsDiv = d$2.createElement('div');
	    var defaultWidth = {};
	    var defaultHeight = {};
	    // creates a span where the fonts will be loaded
	    var createSpan = function () {
	        var span = d$2.createElement('span');
	        span.textContent = testString;
	        for (var _i = 0, _a = Object.keys(fontSpanStyle); _i < _a.length; _i++) {
	            var prop = _a[_i];
	            span.style[prop] = fontSpanStyle[prop];
	        }
	        return span;
	    };
	    // creates a span and load the font to detect and a base font for fallback
	    var createSpanWithFonts = function (fontToDetect, baseFont) {
	        var s = createSpan();
	        s.style.fontFamily = "'" + fontToDetect + "'," + baseFont;
	        return s;
	    };
	    // creates spans for the base fonts and adds them to baseFontsDiv
	    var initializeBaseFontsSpans = function () {
	        return baseFonts.map(function (baseFont) {
	            var s = createSpan();
	            s.style.fontFamily = baseFont;
	            baseFontsDiv.appendChild(s);
	            return s;
	        });
	    };
	    // creates spans for the fonts to detect and adds them to fontsDiv
	    var initializeFontsSpans = function () {
	        // Stores {fontName : [spans for that font]}
	        var spans = {};
	        var _loop_1 = function (font) {
	            spans[font] = baseFonts.map(function (baseFont) {
	                var s = createSpanWithFonts(font, baseFont);
	                fontsDiv.appendChild(s);
	                return s;
	            });
	        };
	        for (var _i = 0, fontList_1 = fontList; _i < fontList_1.length; _i++) {
	            var font = fontList_1[_i];
	            _loop_1(font);
	        }
	        return spans;
	    };
	    // checks if a font is available
	    var isFontAvailable = function (fontSpans) {
	        return baseFonts.some(function (baseFont, baseFontIndex) {
	            return fontSpans[baseFontIndex].offsetWidth !== defaultWidth[baseFont] ||
	                fontSpans[baseFontIndex].offsetHeight !== defaultHeight[baseFont];
	        });
	    };
	    // create spans for base fonts
	    var baseFontsSpans = initializeBaseFontsSpans();
	    // add the spans to the DOM
	    h.appendChild(baseFontsDiv);
	    // get the default width for the three base fonts
	    for (var index = 0, length_1 = baseFonts.length; index < length_1; index++) {
	        defaultWidth[baseFonts[index]] = baseFontsSpans[index].offsetWidth; // width for the default font
	        defaultHeight[baseFonts[index]] = baseFontsSpans[index].offsetHeight; // height for the default font
	    }
	    // create spans for fonts to detect
	    var fontsSpans = initializeFontsSpans();
	    // add all the spans to the DOM
	    h.appendChild(fontsDiv);
	    // check available fonts
	    var available = [];
	    for (var i = 0, l = fontList.length; i < l; i++) {
	        if (isFontAvailable(fontsSpans[fontList[i]])) {
	            available.push(fontList[i]);
	        }
	    }
	    // remove spans from DOM
	    h.removeChild(fontsDiv);
	    h.removeChild(baseFontsDiv);
	    return available;
	}

	function getPlugins() {
	    if (isTrident()) {
	        return [];
	    }
	    if (!navigator.plugins) {
	        return undefined;
	    }
	    var plugins = [];
	    // Safari 10 doesn't support iterating navigator.plugins with for...of
	    for (var i = 0; i < navigator.plugins.length; ++i) {
	        var plugin = navigator.plugins[i];
	        if (!plugin) {
	            continue;
	        }
	        var mimeTypes = [];
	        for (var j = 0; j < plugin.length; ++j) {
	            var mimeType = plugin[j];
	            mimeTypes.push({
	                type: mimeType.type,
	                suffixes: mimeType.suffixes,
	            });
	        }
	        plugins.push({
	            name: plugin.name,
	            description: plugin.description,
	            mimeTypes: mimeTypes,
	        });
	    }
	    return plugins;
	}

	function makeCanvasContext() {
	    var canvas = document.createElement('canvas');
	    canvas.width = 240;
	    canvas.height = 140;
	    canvas.style.display = 'inline';
	    return [canvas, canvas.getContext('2d')];
	}
	function isSupported(canvas, context) {
	    // TODO: look into: https://developer.mozilla.org/en-US/docs/Web/API/HTMLCanvasElement/toBlob
	    return !!(context && canvas.toDataURL);
	}
	function save(canvas) {
	    // TODO: look into: https://developer.mozilla.org/en-US/docs/Web/API/HTMLCanvasElement/toBlob
	    return canvas.toDataURL();
	}
	// https://www.browserleaks.com/canvas#how-does-it-work
	function getCanvasFingerprint() {
	    var _a = makeCanvasContext(), canvas = _a[0], context = _a[1];
	    if (!isSupported(canvas, context)) {
	        return { winding: false, data: '' };
	    }
	    // detect browser support of canvas winding
	    // http://blogs.adobe.com/webplatform/2013/01/30/winding-rules-in-canvas/
	    // https://github.com/Modernizr/Modernizr/blob/master/feature-detects/canvas/winding.js
	    context.rect(0, 0, 10, 10);
	    context.rect(2, 2, 6, 6);
	    var winding = !context.isPointInPath(5, 5, 'evenodd');
	    context.textBaseline = 'alphabetic';
	    context.fillStyle = '#f60';
	    context.fillRect(125, 1, 62, 20);
	    context.fillStyle = '#069';
	    // https://github.com/Valve/fingerprintjs2/issues/66
	    // this can affect FP generation when applying different CSS on different websites
	    context.font = '11pt no-real-font-123';
	    // the choice of emojis has a gigantic impact on rendering performance (especially in FF)
	    // some newer emojis cause it to slow down 50-200 times
	    // context.fillText("Cw爨m fjordbank \ud83d\ude03 gly", 2, 15)
	    var printedText = 'Cwm fjordbank \ud83d\ude03 gly';
	    context.fillText(printedText, 2, 15);
	    context.fillStyle = 'rgba(102, 204, 0, 0.2)';
	    context.font = '18pt Arial';
	    context.fillText(printedText, 4, 45);
	    // canvas blending
	    // http://blogs.adobe.com/webplatform/2013/01/28/blending-features-in-canvas/
	    // http://jsfiddle.net/NDYV8/16/
	    context.globalCompositeOperation = 'multiply';
	    context.fillStyle = 'rgb(255,0,255)';
	    context.beginPath();
	    context.arc(50, 50, 50, 0, Math.PI * 2, true);
	    context.closePath();
	    context.fill();
	    context.fillStyle = 'rgb(0,255,255)';
	    context.beginPath();
	    context.arc(100, 50, 50, 0, Math.PI * 2, true);
	    context.closePath();
	    context.fill();
	    context.fillStyle = 'rgb(255,255,0)';
	    context.beginPath();
	    context.arc(75, 100, 50, 0, Math.PI * 2, true);
	    context.closePath();
	    context.fill();
	    context.fillStyle = 'rgb(255,0,255)';
	    // canvas winding
	    // http://blogs.adobe.com/webplatform/2013/01/30/winding-rules-in-canvas/
	    // http://jsfiddle.net/NDYV8/19/
	    context.arc(75, 75, 75, 0, Math.PI * 2, true);
	    context.arc(75, 75, 25, 0, Math.PI * 2, true);
	    context.fill('evenodd');
	    return {
	        winding: winding,
	        data: save(canvas),
	    };
	}

	var n$1 = navigator;
	var w$3 = window;
	/**
	 * This is a crude and primitive touch screen detection. It's not possible to currently reliably detect the availability
	 * of a touch screen with a JS, without actually subscribing to a touch event.
	 *
	 * @see http://www.stucox.com/blog/you-cant-detect-a-touchscreen/
	 * @see https://github.com/Modernizr/Modernizr/issues/548
	 */
	function getTouchSupport() {
	    var maxTouchPoints = 0;
	    var touchEvent;
	    if (n$1.maxTouchPoints !== undefined) {
	        maxTouchPoints = toInt(n$1.maxTouchPoints);
	    }
	    else if (n$1.msMaxTouchPoints !== undefined) {
	        maxTouchPoints = n$1.msMaxTouchPoints;
	    }
	    try {
	        document.createEvent('TouchEvent');
	        touchEvent = true;
	    }
	    catch (_) {
	        touchEvent = false;
	    }
	    var touchStart = 'ontouchstart' in w$3;
	    return {
	        maxTouchPoints: maxTouchPoints,
	        touchEvent: touchEvent,
	        touchStart: touchStart,
	    };
	}

	function getOsCpu() {
	    return navigator.oscpu;
	}

	var n$2 = navigator;
	function getLanguages() {
	    var result = [];
	    var language = n$2.language || n$2.userLanguage || n$2.browserLanguage || n$2.systemLanguage;
	    if (language !== undefined) {
	        result.push([language]);
	    }
	    if (Array.isArray(n$2.languages)) {
	        // Starting from Chromium 86, there is only a single value in `navigator.language` in Incognito mode:
	        // the value of `navigator.language`. Therefore the value is ignored in this browser.
	        if (!(isChromium() && isChromium86OrNewer())) {
	            result.push(n$2.languages);
	        }
	    }
	    else if (typeof n$2.languages === 'string') {
	        var languages = n$2.languages;
	        if (languages) {
	            result.push(languages.split(','));
	        }
	    }
	    return result;
	}

	function getColorDepth() {
	    return window.screen.colorDepth;
	}

	function getDeviceMemory() {
	    // `navigator.deviceMemory` is a string containing a number in some unidentified cases
	    return replaceNaN(toFloat(navigator.deviceMemory), undefined);
	}

	var w$4 = window;
	function getScreenResolution() {
	    // Some browsers return screen resolution as strings, e.g. "1200", instead of a number, e.g. 1200.
	    // I suspect it's done by certain plugins that randomize browser properties to prevent fingerprinting.
	    var dimensions = [toInt(w$4.screen.width), toInt(w$4.screen.height)];
	    dimensions.sort().reverse();
	    return dimensions;
	}

	var w$5 = window;
	function getAvailableScreenResolution() {
	    if (w$5.screen.availWidth && w$5.screen.availHeight) {
	        // Some browsers return screen resolution as strings, e.g. "1200", instead of a number, e.g. 1200.
	        // I suspect it's done by certain plugins that randomize browser properties to prevent fingerprinting.
	        var dimensions = [toInt(w$5.screen.availWidth), toInt(w$5.screen.availHeight)];
	        dimensions.sort().reverse();
	        return dimensions;
	    }
	    return undefined;
	}

	function getHardwareConcurrency() {
	    try {
	        // sometimes hardware concurrency is a string
	        var concurrency = toInt(navigator.hardwareConcurrency);
	        return isNaN(concurrency) ? 1 : concurrency;
	    }
	    catch (e) {
	        return 1;
	    }
	}

	function getTimezoneOffset() {
	    var currentYear = new Date().getFullYear();
	    // The timezone offset may change over time due to daylight saving time (DST) shifts.
	    // The non-DST timezone offset is used as the result timezone offset.
	    // Since the DST season differs in the northern and the southern hemispheres,
	    // both January and July timezones offsets are considered.
	    return Math.max(
	    // `getTimezoneOffset` returns a number as a string in some unidentified cases
	    toFloat(new Date(currentYear, 0, 1).getTimezoneOffset()), toFloat(new Date(currentYear, 6, 1).getTimezoneOffset()));
	}

	var w$6 = window;
	function getTimezone() {
	    var _a;
	    if ((_a = w$6.Intl) === null || _a === void 0 ? void 0 : _a.DateTimeFormat) {
	        return new w$6.Intl.DateTimeFormat().resolvedOptions().timeZone;
	    }
	    return undefined;
	}

	function getSessionStorage() {
	    try {
	        return !!window.sessionStorage;
	    }
	    catch (error) {
	        /* SecurityError when referencing it means it exists */
	        return true;
	    }
	}

	// https://bugzilla.mozilla.org/show_bug.cgi?id=781447
	function getLocalStorage() {
	    try {
	        return !!window.localStorage;
	    }
	    catch (e) {
	        /* SecurityError when referencing it means it exists */
	        return true;
	    }
	}

	function getIndexedDB() {
	    // IE and Edge don't allow accessing indexedDB in private mode, therefore IE and Edge will have different
	    // visitor identifier in normal and private modes.
	    if (isTrident() || isEdgeHTML()) {
	        return undefined;
	    }
	    try {
	        return !!window.indexedDB;
	    }
	    catch (e) {
	        /* SecurityError when referencing it means it exists */
	        return true;
	    }
	}

	function getOpenDatabase() {
	    return !!window.openDatabase;
	}

	function getCpuClass() {
	    return navigator.cpuClass;
	}

	/**
	 * It should be improved to handle mock value on iOS:
	 * https://github.com/fingerprintjs/fingerprintjs/issues/514#issuecomment-727782842
	 */
	function getPlatform() {
	    return navigator.platform;
	}

	function getPluginsSupport() {
	    return navigator.plugins !== undefined;
	}

	function getProductSub() {
	    return navigator.productSub;
	}

	function getEmptyEvalLength() {
	    return eval.toString().length;
	}

	function getErrorFF() {
	    try {
	        throw 'a';
	    }
	    catch (e) {
	        try {
	            e.toSource();
	            return true;
	        }
	        catch (e2) {
	            return false;
	        }
	    }
	}

	function getVendor() {
	    return navigator.vendor;
	}

	function getChrome() {
	    return window.chrome !== undefined;
	}

	var d$3 = document;
	/**
	 * navigator.cookieEnabled cannot detect custom or nuanced cookie blocking configurations. For example, when blocking
	 * cookies via the Advanced Privacy Settings in IE9, it always returns true. And there have been issues in the past with
	 * site-specific exceptions. Don't rely on it.
	 *
	 * @see https://github.com/Modernizr/Modernizr/blob/master/feature-detects/cookies.js Taken from here
	 */
	function areCookiesEnabled() {
	    // Taken from here: https://github.com/Modernizr/Modernizr/blob/master/feature-detects/cookies.js
	    // navigator.cookieEnabled cannot detect custom or nuanced cookie blocking configurations. For example, when blocking
	    // cookies via the Advanced Privacy Settings in IE9, it always returns true. And there have been issues in the past
	    // with site-specific exceptions. Don't rely on it.
	    // try..catch because some in situations `document.cookie` is exposed but throws a
	    // SecurityError if you try to access it; e.g. documents created from data URIs
	    // or in sandboxed iframes (depending on flags/context)
	    try {
	        // Create cookie
	        d$3.cookie = 'cookietest=1';
	        var result = d$3.cookie.indexOf('cookietest=') !== -1;
	        // Delete cookie
	        d$3.cookie = 'cookietest=1; expires=Thu, 01-Jan-1970 00:00:01 GMT';
	        return result;
	    }
	    catch (e) {
	        return false;
	    }
	}

	/**
	 * The list of entropy sources used to make visitor identifiers.
	 *
	 * This value isn't restricted by Semantic Versioning, i.e. it may be changed without bumping minor or major version of
	 * this package.
	 */
	var sources = {
	    // Expected errors and default values must be handled inside the functions. Unexpected errors must be thrown.
	    osCpu: getOsCpu,
	    languages: getLanguages,
	    colorDepth: getColorDepth,
	    deviceMemory: getDeviceMemory,
	    screenResolution: getScreenResolution,
	    availableScreenResolution: getAvailableScreenResolution,
	    hardwareConcurrency: getHardwareConcurrency,
	    timezoneOffset: getTimezoneOffset,
	    timezone: getTimezone,
	    sessionStorage: getSessionStorage,
	    localStorage: getLocalStorage,
	    indexedDB: getIndexedDB,
	    openDatabase: getOpenDatabase,
	    cpuClass: getCpuClass,
	    platform: getPlatform,
	    plugins: getPlugins,
	    canvas: getCanvasFingerprint,
	    // adBlock: isAdblockUsed, // https://github.com/fingerprintjs/fingerprintjs/issues/405
	    touchSupport: getTouchSupport,
	    fonts: getFonts,
	    audio: getAudioFingerprint,
	    pluginsSupport: getPluginsSupport,
	    productSub: getProductSub,
	    emptyEvalLength: getEmptyEvalLength,
	    errorFF: getErrorFF,
	    vendor: getVendor,
	    chrome: getChrome,
	    cookiesEnabled: areCookiesEnabled,
	};
	/**
	 * Gets a components list from the given list of entropy sources.
	 *
	 * Warning for package users:
	 * This function is out of Semantic Versioning, i.e. can change unexpectedly. Usage is at your own risk.
	 */
	function getComponents(sources, sourceOptions, excludeSources) {
	    return __awaiter(this, void 0, void 0, function () {
	        var timestamp, components, _i, _a, sourceKey, result, error_1, nextTimestamp;
	        var _b;
	        return __generator(this, function (_c) {
	            switch (_c.label) {
	                case 0:
	                    timestamp = Date.now();
	                    components = {};
	                    _i = 0, _a = Object.keys(sources);
	                    _c.label = 1;
	                case 1:
	                    if (!(_i < _a.length)) return [3 /*break*/, 7];
	                    sourceKey = _a[_i];
	                    if (!excludes(excludeSources, sourceKey)) {
	                        return [3 /*break*/, 6];
	                    }
	                    result = void 0;
	                    _c.label = 2;
	                case 2:
	                    _c.trys.push([2, 4, , 5]);
	                    _b = {};
	                    return [4 /*yield*/, sources[sourceKey](sourceOptions)];
	                case 3:
	                    result = (_b.value = _c.sent(), _b);
	                    return [3 /*break*/, 5];
	                case 4:
	                    error_1 = _c.sent();
	                    result = error_1 && typeof error_1 === 'object' && 'message' in error_1 ? { error: error_1 } : { error: { message: error_1 } };
	                    return [3 /*break*/, 5];
	                case 5:
	                    nextTimestamp = Date.now();
	                    components[sourceKey] = __assign(__assign({}, result), { duration: nextTimestamp - timestamp }); // TypeScript has beaten me here
	                    timestamp = nextTimestamp;
	                    _c.label = 6;
	                case 6:
	                    _i++;
	                    return [3 /*break*/, 1];
	                case 7: return [2 /*return*/, components];
	            }
	        });
	    });
	}
	/**
	 * Collects entropy components from the built-in sources to make the visitor identifier.
	 */
	function getBuiltinComponents() {
	    return getComponents(sources, undefined, []);
	}

	function componentsToCanonicalString(components) {
	    var result = '';
	    for (var _i = 0, _a = Object.keys(components); _i < _a.length; _i++) {
	        var componentKey = _a[_i];
	        var component = components[componentKey];
	        var value = component.error ? 'error' : JSON.stringify(component.value);
	        result += "" + (result ? '|' : '') + componentKey.replace(/([:|\\])/g, '\\$1') + ":" + value;
	    }
	    return result;
	}
	function componentsToDebugString(components) {
	    return JSON.stringify(components, function (_key, value) {
	        if (value instanceof Error) {
	            return errorToObject(value);
	        }
	        return value;
	    }, 2);
	}
	function hashComponents(components) {
	    return x64hash128(componentsToCanonicalString(components));
	}
	/**
	 * Makes a GetResult implementation that calculates the visitor id hash on demand.
	 * Designed for optimisation.
	 */
	function makeLazyGetResult(components) {
	    var visitorIdCache;
	    // A plain class isn't used because its getters and setters aren't enumerable.
	    return {
	        components: components,
	        get visitorId() {
	            if (visitorIdCache === undefined) {
	                visitorIdCache = hashComponents(this.components);
	            }
	            return visitorIdCache;
	        },
	        set visitorId(visitorId) {
	            visitorIdCache = visitorId;
	        },
	    };
	}
	/**
	 * The class isn't exported from the index file to not expose the constructor.
	 * The hiding gives more freedom for future non-breaking updates.
	 */
	var OpenAgent = /** @class */ (function () {
	    function OpenAgent() {
	    }
	    /**
	     * @inheritDoc
	     */
	    OpenAgent.prototype.get = function (options) {
	        if (options === void 0) { options = {}; }
	        return __awaiter(this, void 0, void 0, function () {
	            var components, result;
	            return __generator(this, function (_a) {
	                switch (_a.label) {
	                    case 0: return [4 /*yield*/, getBuiltinComponents()];
	                    case 1:
	                        components = _a.sent();
	                        result = makeLazyGetResult(components);
	                        if (options.debug) {
	                            // console.log is ok here because it's under a debug clause
	                            // eslint-disable-next-line no-console
	                            console.log("Copy the text below to get the debug data:\n\n```\nversion: " + version + "\nuserAgent: " + navigator.userAgent + "\ngetOptions: " + JSON.stringify(options, undefined, 2) + "\nvisitorId: " + result.visitorId + "\ncomponents: " + componentsToDebugString(components) + "\n```");
	                        }
	                        return [2 /*return*/, result];
	                }
	            });
	        });
	    };
	    return OpenAgent;
	}());
	/**
	 * Builds an instance of Agent and waits a delay required for a proper operation.
	 */
	function load(_a) {
	    var _b = (_a === void 0 ? {} : _a).delayFallback, delayFallback = _b === void 0 ? 50 : _b;
	    return __awaiter(this, void 0, void 0, function () {
	        return __generator(this, function (_c) {
	            switch (_c.label) {
	                case 0: 
	                // A delay is required to ensure consistent entropy components.
	                // See https://github.com/fingerprintjs/fingerprintjs/issues/254
	                // and https://github.com/fingerprintjs/fingerprintjs/issues/307
	                // and https://github.com/fingerprintjs/fingerprintjs/commit/945633e7c5f67ae38eb0fea37349712f0e669b18
	                // A proper deadline is unknown. Let it be twice the fallback timeout so that both cases have the same average time.
	                return [4 /*yield*/, requestIdleCallbackIfAvailable(delayFallback, delayFallback * 2)];
	                case 1:
	                    // A delay is required to ensure consistent entropy components.
	                    // See https://github.com/fingerprintjs/fingerprintjs/issues/254
	                    // and https://github.com/fingerprintjs/fingerprintjs/issues/307
	                    // and https://github.com/fingerprintjs/fingerprintjs/commit/945633e7c5f67ae38eb0fea37349712f0e669b18
	                    // A proper deadline is unknown. Let it be twice the fallback timeout so that both cases have the same average time.
	                    _c.sent();
	                    return [2 /*return*/, new OpenAgent()];
	            }
	        });
	    });
	}

	// The default export is a syntax sugar (`import * as FP from '...' → import FP from '...'`).
	// It should contain all the public exported values.
	var index = { load: load, hashComponents: hashComponents, componentsToDebugString: componentsToDebugString };

	var es5 = createCommonjsModule(function (module, exports) {
	!function(e,t){module.exports=t();}(commonjsGlobal,(function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n});},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0});},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(n,i,function(t){return e[t]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=90)}({17:function(e,t,r){t.__esModule=!0,t.default=void 0;var n=r(18),i=function(){function e(){}return e.getFirstMatch=function(e,t){var r=t.match(e);return r&&r.length>0&&r[1]||""},e.getSecondMatch=function(e,t){var r=t.match(e);return r&&r.length>1&&r[2]||""},e.matchAndReturnConst=function(e,t,r){if(e.test(t))return r},e.getWindowsVersionName=function(e){switch(e){case"NT":return "NT";case"XP":return "XP";case"NT 5.0":return "2000";case"NT 5.1":return "XP";case"NT 5.2":return "2003";case"NT 6.0":return "Vista";case"NT 6.1":return "7";case"NT 6.2":return "8";case"NT 6.3":return "8.1";case"NT 10.0":return "10";default:return}},e.getMacOSVersionName=function(e){var t=e.split(".").splice(0,2).map((function(e){return parseInt(e,10)||0}));if(t.push(0),10===t[0])switch(t[1]){case 5:return "Leopard";case 6:return "Snow Leopard";case 7:return "Lion";case 8:return "Mountain Lion";case 9:return "Mavericks";case 10:return "Yosemite";case 11:return "El Capitan";case 12:return "Sierra";case 13:return "High Sierra";case 14:return "Mojave";case 15:return "Catalina";default:return}},e.getAndroidVersionName=function(e){var t=e.split(".").splice(0,2).map((function(e){return parseInt(e,10)||0}));if(t.push(0),!(1===t[0]&&t[1]<5))return 1===t[0]&&t[1]<6?"Cupcake":1===t[0]&&t[1]>=6?"Donut":2===t[0]&&t[1]<2?"Eclair":2===t[0]&&2===t[1]?"Froyo":2===t[0]&&t[1]>2?"Gingerbread":3===t[0]?"Honeycomb":4===t[0]&&t[1]<1?"Ice Cream Sandwich":4===t[0]&&t[1]<4?"Jelly Bean":4===t[0]&&t[1]>=4?"KitKat":5===t[0]?"Lollipop":6===t[0]?"Marshmallow":7===t[0]?"Nougat":8===t[0]?"Oreo":9===t[0]?"Pie":void 0},e.getVersionPrecision=function(e){return e.split(".").length},e.compareVersions=function(t,r,n){void 0===n&&(n=!1);var i=e.getVersionPrecision(t),s=e.getVersionPrecision(r),a=Math.max(i,s),o=0,u=e.map([t,r],(function(t){var r=a-e.getVersionPrecision(t),n=t+new Array(r+1).join(".0");return e.map(n.split("."),(function(e){return new Array(20-e.length).join("0")+e})).reverse()}));for(n&&(o=a-Math.min(i,s)),a-=1;a>=o;){if(u[0][a]>u[1][a])return 1;if(u[0][a]===u[1][a]){if(a===o)return 0;a-=1;}else if(u[0][a]<u[1][a])return -1}},e.map=function(e,t){var r,n=[];if(Array.prototype.map)return Array.prototype.map.call(e,t);for(r=0;r<e.length;r+=1)n.push(t(e[r]));return n},e.find=function(e,t){var r,n;if(Array.prototype.find)return Array.prototype.find.call(e,t);for(r=0,n=e.length;r<n;r+=1){var i=e[r];if(t(i,r))return i}},e.assign=function(e){for(var t,r,n=e,i=arguments.length,s=new Array(i>1?i-1:0),a=1;a<i;a++)s[a-1]=arguments[a];if(Object.assign)return Object.assign.apply(Object,[e].concat(s));var o=function(){var e=s[t];"object"==typeof e&&null!==e&&Object.keys(e).forEach((function(t){n[t]=e[t];}));};for(t=0,r=s.length;t<r;t+=1)o();return e},e.getBrowserAlias=function(e){return n.BROWSER_ALIASES_MAP[e]},e.getBrowserTypeByAlias=function(e){return n.BROWSER_MAP[e]||""},e}();t.default=i,e.exports=t.default;},18:function(e,t,r){t.__esModule=!0,t.ENGINE_MAP=t.OS_MAP=t.PLATFORMS_MAP=t.BROWSER_MAP=t.BROWSER_ALIASES_MAP=void 0;t.BROWSER_ALIASES_MAP={"Amazon Silk":"amazon_silk","Android Browser":"android",Bada:"bada",BlackBerry:"blackberry",Chrome:"chrome",Chromium:"chromium",Electron:"electron",Epiphany:"epiphany",Firefox:"firefox",Focus:"focus",Generic:"generic","Google Search":"google_search",Googlebot:"googlebot","Internet Explorer":"ie","K-Meleon":"k_meleon",Maxthon:"maxthon","Microsoft Edge":"edge","MZ Browser":"mz","NAVER Whale Browser":"naver",Opera:"opera","Opera Coast":"opera_coast",PhantomJS:"phantomjs",Puffin:"puffin",QupZilla:"qupzilla",QQ:"qq",QQLite:"qqlite",Safari:"safari",Sailfish:"sailfish","Samsung Internet for Android":"samsung_internet",SeaMonkey:"seamonkey",Sleipnir:"sleipnir",Swing:"swing",Tizen:"tizen","UC Browser":"uc",Vivaldi:"vivaldi","WebOS Browser":"webos",WeChat:"wechat","Yandex Browser":"yandex",Roku:"roku"};t.BROWSER_MAP={amazon_silk:"Amazon Silk",android:"Android Browser",bada:"Bada",blackberry:"BlackBerry",chrome:"Chrome",chromium:"Chromium",electron:"Electron",epiphany:"Epiphany",firefox:"Firefox",focus:"Focus",generic:"Generic",googlebot:"Googlebot",google_search:"Google Search",ie:"Internet Explorer",k_meleon:"K-Meleon",maxthon:"Maxthon",edge:"Microsoft Edge",mz:"MZ Browser",naver:"NAVER Whale Browser",opera:"Opera",opera_coast:"Opera Coast",phantomjs:"PhantomJS",puffin:"Puffin",qupzilla:"QupZilla",qq:"QQ Browser",qqlite:"QQ Browser Lite",safari:"Safari",sailfish:"Sailfish",samsung_internet:"Samsung Internet for Android",seamonkey:"SeaMonkey",sleipnir:"Sleipnir",swing:"Swing",tizen:"Tizen",uc:"UC Browser",vivaldi:"Vivaldi",webos:"WebOS Browser",wechat:"WeChat",yandex:"Yandex Browser"};t.PLATFORMS_MAP={tablet:"tablet",mobile:"mobile",desktop:"desktop",tv:"tv"};t.OS_MAP={WindowsPhone:"Windows Phone",Windows:"Windows",MacOS:"macOS",iOS:"iOS",Android:"Android",WebOS:"WebOS",BlackBerry:"BlackBerry",Bada:"Bada",Tizen:"Tizen",Linux:"Linux",ChromeOS:"Chrome OS",PlayStation4:"PlayStation 4",Roku:"Roku"};t.ENGINE_MAP={EdgeHTML:"EdgeHTML",Blink:"Blink",Trident:"Trident",Presto:"Presto",Gecko:"Gecko",WebKit:"WebKit"};},90:function(e,t,r){t.__esModule=!0,t.default=void 0;var n,i=(n=r(91))&&n.__esModule?n:{default:n},s=r(18);function a(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n);}}var o=function(){function e(){}var t,r,n;return e.getParser=function(e,t){if(void 0===t&&(t=!1),"string"!=typeof e)throw new Error("UserAgent should be a string");return new i.default(e,t)},e.parse=function(e){return new i.default(e).getResult()},t=e,n=[{key:"BROWSER_MAP",get:function(){return s.BROWSER_MAP}},{key:"ENGINE_MAP",get:function(){return s.ENGINE_MAP}},{key:"OS_MAP",get:function(){return s.OS_MAP}},{key:"PLATFORMS_MAP",get:function(){return s.PLATFORMS_MAP}}],(r=null)&&a(t.prototype,r),n&&a(t,n),e}();t.default=o,e.exports=t.default;},91:function(e,t,r){t.__esModule=!0,t.default=void 0;var n=u(r(92)),i=u(r(93)),s=u(r(94)),a=u(r(95)),o=u(r(17));function u(e){return e&&e.__esModule?e:{default:e}}var d=function(){function e(e,t){if(void 0===t&&(t=!1),null==e||""===e)throw new Error("UserAgent parameter can't be empty");this._ua=e,this.parsedResult={},!0!==t&&this.parse();}var t=e.prototype;return t.getUA=function(){return this._ua},t.test=function(e){return e.test(this._ua)},t.parseBrowser=function(){var e=this;this.parsedResult.browser={};var t=o.default.find(n.default,(function(t){if("function"==typeof t.test)return t.test(e);if(t.test instanceof Array)return t.test.some((function(t){return e.test(t)}));throw new Error("Browser's test function is not valid")}));return t&&(this.parsedResult.browser=t.describe(this.getUA())),this.parsedResult.browser},t.getBrowser=function(){return this.parsedResult.browser?this.parsedResult.browser:this.parseBrowser()},t.getBrowserName=function(e){return e?String(this.getBrowser().name).toLowerCase()||"":this.getBrowser().name||""},t.getBrowserVersion=function(){return this.getBrowser().version},t.getOS=function(){return this.parsedResult.os?this.parsedResult.os:this.parseOS()},t.parseOS=function(){var e=this;this.parsedResult.os={};var t=o.default.find(i.default,(function(t){if("function"==typeof t.test)return t.test(e);if(t.test instanceof Array)return t.test.some((function(t){return e.test(t)}));throw new Error("Browser's test function is not valid")}));return t&&(this.parsedResult.os=t.describe(this.getUA())),this.parsedResult.os},t.getOSName=function(e){var t=this.getOS().name;return e?String(t).toLowerCase()||"":t||""},t.getOSVersion=function(){return this.getOS().version},t.getPlatform=function(){return this.parsedResult.platform?this.parsedResult.platform:this.parsePlatform()},t.getPlatformType=function(e){void 0===e&&(e=!1);var t=this.getPlatform().type;return e?String(t).toLowerCase()||"":t||""},t.parsePlatform=function(){var e=this;this.parsedResult.platform={};var t=o.default.find(s.default,(function(t){if("function"==typeof t.test)return t.test(e);if(t.test instanceof Array)return t.test.some((function(t){return e.test(t)}));throw new Error("Browser's test function is not valid")}));return t&&(this.parsedResult.platform=t.describe(this.getUA())),this.parsedResult.platform},t.getEngine=function(){return this.parsedResult.engine?this.parsedResult.engine:this.parseEngine()},t.getEngineName=function(e){return e?String(this.getEngine().name).toLowerCase()||"":this.getEngine().name||""},t.parseEngine=function(){var e=this;this.parsedResult.engine={};var t=o.default.find(a.default,(function(t){if("function"==typeof t.test)return t.test(e);if(t.test instanceof Array)return t.test.some((function(t){return e.test(t)}));throw new Error("Browser's test function is not valid")}));return t&&(this.parsedResult.engine=t.describe(this.getUA())),this.parsedResult.engine},t.parse=function(){return this.parseBrowser(),this.parseOS(),this.parsePlatform(),this.parseEngine(),this},t.getResult=function(){return o.default.assign({},this.parsedResult)},t.satisfies=function(e){var t=this,r={},n=0,i={},s=0;if(Object.keys(e).forEach((function(t){var a=e[t];"string"==typeof a?(i[t]=a,s+=1):"object"==typeof a&&(r[t]=a,n+=1);})),n>0){var a=Object.keys(r),u=o.default.find(a,(function(e){return t.isOS(e)}));if(u){var d=this.satisfies(r[u]);if(void 0!==d)return d}var c=o.default.find(a,(function(e){return t.isPlatform(e)}));if(c){var f=this.satisfies(r[c]);if(void 0!==f)return f}}if(s>0){var l=Object.keys(i),h=o.default.find(l,(function(e){return t.isBrowser(e,!0)}));if(void 0!==h)return this.compareVersion(i[h])}},t.isBrowser=function(e,t){void 0===t&&(t=!1);var r=this.getBrowserName().toLowerCase(),n=e.toLowerCase(),i=o.default.getBrowserTypeByAlias(n);return t&&i&&(n=i.toLowerCase()),n===r},t.compareVersion=function(e){var t=[0],r=e,n=!1,i=this.getBrowserVersion();if("string"==typeof i)return ">"===e[0]||"<"===e[0]?(r=e.substr(1),"="===e[1]?(n=!0,r=e.substr(2)):t=[],">"===e[0]?t.push(1):t.push(-1)):"="===e[0]?r=e.substr(1):"~"===e[0]&&(n=!0,r=e.substr(1)),t.indexOf(o.default.compareVersions(i,r,n))>-1},t.isOS=function(e){return this.getOSName(!0)===String(e).toLowerCase()},t.isPlatform=function(e){return this.getPlatformType(!0)===String(e).toLowerCase()},t.isEngine=function(e){return this.getEngineName(!0)===String(e).toLowerCase()},t.is=function(e,t){return void 0===t&&(t=!1),this.isBrowser(e,t)||this.isOS(e)||this.isPlatform(e)},t.some=function(e){var t=this;return void 0===e&&(e=[]),e.some((function(e){return t.is(e)}))},e}();t.default=d,e.exports=t.default;},92:function(e,t,r){t.__esModule=!0,t.default=void 0;var n,i=(n=r(17))&&n.__esModule?n:{default:n};var s=/version\/(\d+(\.?_?\d+)+)/i,a=[{test:[/googlebot/i],describe:function(e){var t={name:"Googlebot"},r=i.default.getFirstMatch(/googlebot\/(\d+(\.\d+))/i,e)||i.default.getFirstMatch(s,e);return r&&(t.version=r),t}},{test:[/opera/i],describe:function(e){var t={name:"Opera"},r=i.default.getFirstMatch(s,e)||i.default.getFirstMatch(/(?:opera)[\s/](\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/opr\/|opios/i],describe:function(e){var t={name:"Opera"},r=i.default.getFirstMatch(/(?:opr|opios)[\s/](\S+)/i,e)||i.default.getFirstMatch(s,e);return r&&(t.version=r),t}},{test:[/SamsungBrowser/i],describe:function(e){var t={name:"Samsung Internet for Android"},r=i.default.getFirstMatch(s,e)||i.default.getFirstMatch(/(?:SamsungBrowser)[\s/](\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/Whale/i],describe:function(e){var t={name:"NAVER Whale Browser"},r=i.default.getFirstMatch(s,e)||i.default.getFirstMatch(/(?:whale)[\s/](\d+(?:\.\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/MZBrowser/i],describe:function(e){var t={name:"MZ Browser"},r=i.default.getFirstMatch(/(?:MZBrowser)[\s/](\d+(?:\.\d+)+)/i,e)||i.default.getFirstMatch(s,e);return r&&(t.version=r),t}},{test:[/focus/i],describe:function(e){var t={name:"Focus"},r=i.default.getFirstMatch(/(?:focus)[\s/](\d+(?:\.\d+)+)/i,e)||i.default.getFirstMatch(s,e);return r&&(t.version=r),t}},{test:[/swing/i],describe:function(e){var t={name:"Swing"},r=i.default.getFirstMatch(/(?:swing)[\s/](\d+(?:\.\d+)+)/i,e)||i.default.getFirstMatch(s,e);return r&&(t.version=r),t}},{test:[/coast/i],describe:function(e){var t={name:"Opera Coast"},r=i.default.getFirstMatch(s,e)||i.default.getFirstMatch(/(?:coast)[\s/](\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/opt\/\d+(?:.?_?\d+)+/i],describe:function(e){var t={name:"Opera Touch"},r=i.default.getFirstMatch(/(?:opt)[\s/](\d+(\.?_?\d+)+)/i,e)||i.default.getFirstMatch(s,e);return r&&(t.version=r),t}},{test:[/yabrowser/i],describe:function(e){var t={name:"Yandex Browser"},r=i.default.getFirstMatch(/(?:yabrowser)[\s/](\d+(\.?_?\d+)+)/i,e)||i.default.getFirstMatch(s,e);return r&&(t.version=r),t}},{test:[/ucbrowser/i],describe:function(e){var t={name:"UC Browser"},r=i.default.getFirstMatch(s,e)||i.default.getFirstMatch(/(?:ucbrowser)[\s/](\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/Maxthon|mxios/i],describe:function(e){var t={name:"Maxthon"},r=i.default.getFirstMatch(s,e)||i.default.getFirstMatch(/(?:Maxthon|mxios)[\s/](\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/epiphany/i],describe:function(e){var t={name:"Epiphany"},r=i.default.getFirstMatch(s,e)||i.default.getFirstMatch(/(?:epiphany)[\s/](\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/puffin/i],describe:function(e){var t={name:"Puffin"},r=i.default.getFirstMatch(s,e)||i.default.getFirstMatch(/(?:puffin)[\s/](\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/sleipnir/i],describe:function(e){var t={name:"Sleipnir"},r=i.default.getFirstMatch(s,e)||i.default.getFirstMatch(/(?:sleipnir)[\s/](\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/k-meleon/i],describe:function(e){var t={name:"K-Meleon"},r=i.default.getFirstMatch(s,e)||i.default.getFirstMatch(/(?:k-meleon)[\s/](\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/micromessenger/i],describe:function(e){var t={name:"WeChat"},r=i.default.getFirstMatch(/(?:micromessenger)[\s/](\d+(\.?_?\d+)+)/i,e)||i.default.getFirstMatch(s,e);return r&&(t.version=r),t}},{test:[/qqbrowser/i],describe:function(e){var t={name:/qqbrowserlite/i.test(e)?"QQ Browser Lite":"QQ Browser"},r=i.default.getFirstMatch(/(?:qqbrowserlite|qqbrowser)[/](\d+(\.?_?\d+)+)/i,e)||i.default.getFirstMatch(s,e);return r&&(t.version=r),t}},{test:[/msie|trident/i],describe:function(e){var t={name:"Internet Explorer"},r=i.default.getFirstMatch(/(?:msie |rv:)(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/\sedg\//i],describe:function(e){var t={name:"Microsoft Edge"},r=i.default.getFirstMatch(/\sedg\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/edg([ea]|ios)/i],describe:function(e){var t={name:"Microsoft Edge"},r=i.default.getSecondMatch(/edg([ea]|ios)\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/vivaldi/i],describe:function(e){var t={name:"Vivaldi"},r=i.default.getFirstMatch(/vivaldi\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/seamonkey/i],describe:function(e){var t={name:"SeaMonkey"},r=i.default.getFirstMatch(/seamonkey\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/sailfish/i],describe:function(e){var t={name:"Sailfish"},r=i.default.getFirstMatch(/sailfish\s?browser\/(\d+(\.\d+)?)/i,e);return r&&(t.version=r),t}},{test:[/silk/i],describe:function(e){var t={name:"Amazon Silk"},r=i.default.getFirstMatch(/silk\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/phantom/i],describe:function(e){var t={name:"PhantomJS"},r=i.default.getFirstMatch(/phantomjs\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/slimerjs/i],describe:function(e){var t={name:"SlimerJS"},r=i.default.getFirstMatch(/slimerjs\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/blackberry|\bbb\d+/i,/rim\stablet/i],describe:function(e){var t={name:"BlackBerry"},r=i.default.getFirstMatch(s,e)||i.default.getFirstMatch(/blackberry[\d]+\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/(web|hpw)[o0]s/i],describe:function(e){var t={name:"WebOS Browser"},r=i.default.getFirstMatch(s,e)||i.default.getFirstMatch(/w(?:eb)?[o0]sbrowser\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/bada/i],describe:function(e){var t={name:"Bada"},r=i.default.getFirstMatch(/dolfin\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/tizen/i],describe:function(e){var t={name:"Tizen"},r=i.default.getFirstMatch(/(?:tizen\s?)?browser\/(\d+(\.?_?\d+)+)/i,e)||i.default.getFirstMatch(s,e);return r&&(t.version=r),t}},{test:[/qupzilla/i],describe:function(e){var t={name:"QupZilla"},r=i.default.getFirstMatch(/(?:qupzilla)[\s/](\d+(\.?_?\d+)+)/i,e)||i.default.getFirstMatch(s,e);return r&&(t.version=r),t}},{test:[/firefox|iceweasel|fxios/i],describe:function(e){var t={name:"Firefox"},r=i.default.getFirstMatch(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/electron/i],describe:function(e){var t={name:"Electron"},r=i.default.getFirstMatch(/(?:electron)\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/MiuiBrowser/i],describe:function(e){var t={name:"Miui"},r=i.default.getFirstMatch(/(?:MiuiBrowser)[\s/](\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/chromium/i],describe:function(e){var t={name:"Chromium"},r=i.default.getFirstMatch(/(?:chromium)[\s/](\d+(\.?_?\d+)+)/i,e)||i.default.getFirstMatch(s,e);return r&&(t.version=r),t}},{test:[/chrome|crios|crmo/i],describe:function(e){var t={name:"Chrome"},r=i.default.getFirstMatch(/(?:chrome|crios|crmo)\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/GSA/i],describe:function(e){var t={name:"Google Search"},r=i.default.getFirstMatch(/(?:GSA)\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:function(e){var t=!e.test(/like android/i),r=e.test(/android/i);return t&&r},describe:function(e){var t={name:"Android Browser"},r=i.default.getFirstMatch(s,e);return r&&(t.version=r),t}},{test:[/playstation 4/i],describe:function(e){var t={name:"PlayStation 4"},r=i.default.getFirstMatch(s,e);return r&&(t.version=r),t}},{test:[/safari|applewebkit/i],describe:function(e){var t={name:"Safari"},r=i.default.getFirstMatch(s,e);return r&&(t.version=r),t}},{test:[/.*/i],describe:function(e){var t=-1!==e.search("\\(")?/^(.*)\/(.*)[ \t]\((.*)/:/^(.*)\/(.*) /;return {name:i.default.getFirstMatch(t,e),version:i.default.getSecondMatch(t,e)}}}];t.default=a,e.exports=t.default;},93:function(e,t,r){t.__esModule=!0,t.default=void 0;var n,i=(n=r(17))&&n.__esModule?n:{default:n},s=r(18);var a=[{test:[/Roku\/DVP/],describe:function(e){var t=i.default.getFirstMatch(/Roku\/DVP-(\d+\.\d+)/i,e);return {name:s.OS_MAP.Roku,version:t}}},{test:[/windows phone/i],describe:function(e){var t=i.default.getFirstMatch(/windows phone (?:os)?\s?(\d+(\.\d+)*)/i,e);return {name:s.OS_MAP.WindowsPhone,version:t}}},{test:[/windows /i],describe:function(e){var t=i.default.getFirstMatch(/Windows ((NT|XP)( \d\d?.\d)?)/i,e),r=i.default.getWindowsVersionName(t);return {name:s.OS_MAP.Windows,version:t,versionName:r}}},{test:[/Macintosh(.*?) FxiOS(.*?)\//],describe:function(e){var t={name:s.OS_MAP.iOS},r=i.default.getSecondMatch(/(Version\/)(\d[\d.]+)/,e);return r&&(t.version=r),t}},{test:[/macintosh/i],describe:function(e){var t=i.default.getFirstMatch(/mac os x (\d+(\.?_?\d+)+)/i,e).replace(/[_\s]/g,"."),r=i.default.getMacOSVersionName(t),n={name:s.OS_MAP.MacOS,version:t};return r&&(n.versionName=r),n}},{test:[/(ipod|iphone|ipad)/i],describe:function(e){var t=i.default.getFirstMatch(/os (\d+([_\s]\d+)*) like mac os x/i,e).replace(/[_\s]/g,".");return {name:s.OS_MAP.iOS,version:t}}},{test:function(e){var t=!e.test(/like android/i),r=e.test(/android/i);return t&&r},describe:function(e){var t=i.default.getFirstMatch(/android[\s/-](\d+(\.\d+)*)/i,e),r=i.default.getAndroidVersionName(t),n={name:s.OS_MAP.Android,version:t};return r&&(n.versionName=r),n}},{test:[/(web|hpw)[o0]s/i],describe:function(e){var t=i.default.getFirstMatch(/(?:web|hpw)[o0]s\/(\d+(\.\d+)*)/i,e),r={name:s.OS_MAP.WebOS};return t&&t.length&&(r.version=t),r}},{test:[/blackberry|\bbb\d+/i,/rim\stablet/i],describe:function(e){var t=i.default.getFirstMatch(/rim\stablet\sos\s(\d+(\.\d+)*)/i,e)||i.default.getFirstMatch(/blackberry\d+\/(\d+([_\s]\d+)*)/i,e)||i.default.getFirstMatch(/\bbb(\d+)/i,e);return {name:s.OS_MAP.BlackBerry,version:t}}},{test:[/bada/i],describe:function(e){var t=i.default.getFirstMatch(/bada\/(\d+(\.\d+)*)/i,e);return {name:s.OS_MAP.Bada,version:t}}},{test:[/tizen/i],describe:function(e){var t=i.default.getFirstMatch(/tizen[/\s](\d+(\.\d+)*)/i,e);return {name:s.OS_MAP.Tizen,version:t}}},{test:[/linux/i],describe:function(){return {name:s.OS_MAP.Linux}}},{test:[/CrOS/],describe:function(){return {name:s.OS_MAP.ChromeOS}}},{test:[/PlayStation 4/],describe:function(e){var t=i.default.getFirstMatch(/PlayStation 4[/\s](\d+(\.\d+)*)/i,e);return {name:s.OS_MAP.PlayStation4,version:t}}}];t.default=a,e.exports=t.default;},94:function(e,t,r){t.__esModule=!0,t.default=void 0;var n,i=(n=r(17))&&n.__esModule?n:{default:n},s=r(18);var a=[{test:[/googlebot/i],describe:function(){return {type:"bot",vendor:"Google"}}},{test:[/huawei/i],describe:function(e){var t=i.default.getFirstMatch(/(can-l01)/i,e)&&"Nova",r={type:s.PLATFORMS_MAP.mobile,vendor:"Huawei"};return t&&(r.model=t),r}},{test:[/nexus\s*(?:7|8|9|10).*/i],describe:function(){return {type:s.PLATFORMS_MAP.tablet,vendor:"Nexus"}}},{test:[/ipad/i],describe:function(){return {type:s.PLATFORMS_MAP.tablet,vendor:"Apple",model:"iPad"}}},{test:[/Macintosh(.*?) FxiOS(.*?)\//],describe:function(){return {type:s.PLATFORMS_MAP.tablet,vendor:"Apple",model:"iPad"}}},{test:[/kftt build/i],describe:function(){return {type:s.PLATFORMS_MAP.tablet,vendor:"Amazon",model:"Kindle Fire HD 7"}}},{test:[/silk/i],describe:function(){return {type:s.PLATFORMS_MAP.tablet,vendor:"Amazon"}}},{test:[/tablet(?! pc)/i],describe:function(){return {type:s.PLATFORMS_MAP.tablet}}},{test:function(e){var t=e.test(/ipod|iphone/i),r=e.test(/like (ipod|iphone)/i);return t&&!r},describe:function(e){var t=i.default.getFirstMatch(/(ipod|iphone)/i,e);return {type:s.PLATFORMS_MAP.mobile,vendor:"Apple",model:t}}},{test:[/nexus\s*[0-6].*/i,/galaxy nexus/i],describe:function(){return {type:s.PLATFORMS_MAP.mobile,vendor:"Nexus"}}},{test:[/[^-]mobi/i],describe:function(){return {type:s.PLATFORMS_MAP.mobile}}},{test:function(e){return "blackberry"===e.getBrowserName(!0)},describe:function(){return {type:s.PLATFORMS_MAP.mobile,vendor:"BlackBerry"}}},{test:function(e){return "bada"===e.getBrowserName(!0)},describe:function(){return {type:s.PLATFORMS_MAP.mobile}}},{test:function(e){return "windows phone"===e.getBrowserName()},describe:function(){return {type:s.PLATFORMS_MAP.mobile,vendor:"Microsoft"}}},{test:function(e){var t=Number(String(e.getOSVersion()).split(".")[0]);return "android"===e.getOSName(!0)&&t>=3},describe:function(){return {type:s.PLATFORMS_MAP.tablet}}},{test:function(e){return "android"===e.getOSName(!0)},describe:function(){return {type:s.PLATFORMS_MAP.mobile}}},{test:function(e){return "macos"===e.getOSName(!0)},describe:function(){return {type:s.PLATFORMS_MAP.desktop,vendor:"Apple"}}},{test:function(e){return "windows"===e.getOSName(!0)},describe:function(){return {type:s.PLATFORMS_MAP.desktop}}},{test:function(e){return "linux"===e.getOSName(!0)},describe:function(){return {type:s.PLATFORMS_MAP.desktop}}},{test:function(e){return "playstation 4"===e.getOSName(!0)},describe:function(){return {type:s.PLATFORMS_MAP.tv}}},{test:function(e){return "roku"===e.getOSName(!0)},describe:function(){return {type:s.PLATFORMS_MAP.tv}}}];t.default=a,e.exports=t.default;},95:function(e,t,r){t.__esModule=!0,t.default=void 0;var n,i=(n=r(17))&&n.__esModule?n:{default:n},s=r(18);var a=[{test:function(e){return "microsoft edge"===e.getBrowserName(!0)},describe:function(e){if(/\sedg\//i.test(e))return {name:s.ENGINE_MAP.Blink};var t=i.default.getFirstMatch(/edge\/(\d+(\.?_?\d+)+)/i,e);return {name:s.ENGINE_MAP.EdgeHTML,version:t}}},{test:[/trident/i],describe:function(e){var t={name:s.ENGINE_MAP.Trident},r=i.default.getFirstMatch(/trident\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:function(e){return e.test(/presto/i)},describe:function(e){var t={name:s.ENGINE_MAP.Presto},r=i.default.getFirstMatch(/presto\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:function(e){var t=e.test(/gecko/i),r=e.test(/like gecko/i);return t&&!r},describe:function(e){var t={name:s.ENGINE_MAP.Gecko},r=i.default.getFirstMatch(/gecko\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}},{test:[/(apple)?webkit\/537\.36/i],describe:function(){return {name:s.ENGINE_MAP.Blink}}},{test:[/(apple)?webkit/i],describe:function(e){var t={name:s.ENGINE_MAP.WebKit},r=i.default.getFirstMatch(/webkit\/(\d+(\.?_?\d+)+)/i,e);return r&&(t.version=r),t}}];t.default=a,e.exports=t.default;}})}));
	});

	// eslint-disable-next-line @typescript-eslint/no-extraneous-class
	class BrowserUtil {
	    static getBrowserId() {
	        return __awaiter(this, void 0, void 0, function* () {
	            const fp = yield index.load();
	            const result = yield fp.get();
	            return result.visitorId;
	        });
	    }
	    static getClientDetails() {
	        const clientDetails = es5.parse(window.navigator.userAgent);
	        return clientDetails;
	    }
	    static getDeviceList() {
	        return __awaiter(this, void 0, void 0, function* () {
	            const deviceList = yield navigator.mediaDevices.enumerateDevices();
	            return deviceList.map((currentDeviceInfo) => ({
	                'deviceId': currentDeviceInfo.deviceId,
	                'groupId': currentDeviceInfo.groupId,
	                'kind': currentDeviceInfo.kind,
	                'label': currentDeviceInfo.label
	            }));
	        });
	    }
	}

	// eslint-disable-next-line @typescript-eslint/no-extraneous-class
	class TimeUtil {
	    static getCurrent() {
	        return Date.now();
	    }
	    static getTimeZoneOffsetInMinute() {
	        const timezoneOffset = new Date().getTimezoneOffset();
	        return timezoneOffset;
	    }
	}

	class ObserverSingleton {
	    constructor() {
	        this.browserId = '';
	        this.activeDeviceList = [];
	        // eslint-disable-next-line @typescript-eslint/no-magic-numbers
	        this.lastDeviceStateCheckedTimestampInMs = 0;
	        // eslint-disable-next-line @typescript-eslint/no-magic-numbers
	        this.offsetInMs = 60 * 1000;
	        this.getBrowserId = this.getBrowserId.bind(this);
	        this.getActiveDeviceList = this.getActiveDeviceList.bind(this);
	    }
	    getBrowserId() {
	        return __awaiter(this, void 0, void 0, function* () {
	            if (this.browserId) {
	                return this.browserId;
	            }
	            this.browserId = yield BrowserUtil.getBrowserId();
	            logger.warn('browser id', this.browserId);
	            return this.browserId;
	        });
	    }
	    getActiveDeviceList() {
	        const nowInMs = TimeUtil.getCurrent();
	        if (nowInMs - this.lastDeviceStateCheckedTimestampInMs > this.offsetInMs) {
	            this.lastDeviceStateCheckedTimestampInMs = nowInMs;
	            BrowserUtil.getDeviceList().then((deviceList) => {
	                this.activeDeviceList = deviceList;
	            }).catch(null);
	        }
	        return this.activeDeviceList;
	    }
	}
	const observerSingleton = new ObserverSingleton();
	// eslint-disable-next-line @typescript-eslint/no-floating-promises
	observerSingleton.getBrowserId().catch();
	// Update active device list in the beginning
	observerSingleton.getActiveDeviceList();

	// eslint-disable-next-line @typescript-eslint/no-extraneous-class
	class RawStatsCollector {
	    static getRawStats(senderOrReceiver) {
	        return __awaiter(this, void 0, void 0, function* () {
	            if (!senderOrReceiver) {
	                return [];
	            }
	            const statsList = [];
	            for (const currentStats of senderOrReceiver) {
	                // eslint-disable-next-line no-await-in-loop
	                const stats = yield currentStats.getStats();
	                for (const value of stats.values()) {
	                    // eslint-disable-next-line @typescript-eslint/strict-boolean-expressions
	                    if (value) {
	                        statsList.push(value);
	                    }
	                }
	            }
	            // eslint-disable-next-line @typescript-eslint/no-unsafe-return
	            return statsList;
	        });
	    }
	    static getReceiver(pc) {
	        return pc === null || pc === void 0 ? void 0 : pc.getReceivers();
	    }
	    static getSender(pc) {
	        return pc === null || pc === void 0 ? void 0 : pc.getSenders();
	    }
	}

	class RTCState {
	    constructor() {
	        this.currentState = 'new';
	        // eslint-disable-next-line @typescript-eslint/no-magic-numbers
	        this.lastUpdate = 0;
	        // eslint-disable-next-line @typescript-eslint/no-magic-numbers
	        this.expiredLimit = 10 * 1000;
	        this.updateState = this.updateState.bind(this);
	        this.isExpired = this.isExpired.bind(this);
	    }
	    updateState(currentState) {
	        if (this.currentState !== currentState) {
	            this.currentState = currentState;
	            this.lastUpdate = TimeUtil.getCurrent();
	        }
	    }
	    isExpired() {
	        if (![
	            'closed',
	            'failed'
	        ].includes(this.currentState)) {
	            return false;
	        }
	        // Connection state is either in closed, or failed state now
	        const now = TimeUtil.getCurrent();
	        return now - this.lastUpdate > this.expiredLimit;
	    }
	}

	class ObserverPC {
	    constructor(userConfig) {
	        this.userConfig = userConfig;
	        // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment,@typescript-eslint/no-unsafe-call
	        this._id = v4();
	        this._timeZoneOffsetInMinute = TimeUtil.getTimeZoneOffsetInMinute();
	        this._rtcState = new RTCState();
	        this.updateConnectionState = this.updateConnectionState.bind(this);
	        this.getStats = this.getStats.bind(this);
	        // eslint-disable-next-line @typescript-eslint/no-floating-promises
	        observerSingleton.getBrowserId().then((value) => {
	            this._browserId = value;
	        });
	    }
	    get id() {
	        return this._id;
	    }
	    getPcDetails(marker) {
	        return {
	            'browserId': this._browserId,
	            'callId': this.userConfig.callId,
	            'clientDetails': BrowserUtil.getClientDetails(),
	            'deviceList': observerSingleton.getActiveDeviceList(),
	            'integration': this.userConfig.integration,
	            marker,
	            'peerConnectionId': this._id,
	            'timeZoneOffsetInMinute': this._timeZoneOffsetInMinute,
	            'timestamp': TimeUtil.getCurrent(),
	            'userId': this.userConfig.userId
	        };
	    }
	    get isExpired() {
	        return this._rtcState.isExpired();
	    }
	    updateConnectionState() {
	        const currentState = this.userConfig.pc.connectionState;
	        this._rtcState.updateState(currentState);
	    }
	    getStats() {
	        return __awaiter(this, void 0, void 0, function* () {
	            const receiverList = RawStatsCollector.getReceiver(this.userConfig.pc);
	            const senderList = RawStatsCollector.getSender(this.userConfig.pc);
	            const [
	            // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment
	            receiverStats, 
	            // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment
	            senderStats] = yield Promise.all([
	                RawStatsCollector.getRawStats(receiverList),
	                RawStatsCollector.getRawStats(senderList)
	            ]);
	            return {
	                'receiverStats': receiverStats,
	                'senderStats': senderStats
	            };
	        });
	    }
	}

	class RTCCollector {
	    constructor() {
	        this.collect = this.collect.bind(this);
	    }
	    updateMarker(marker) {
	        this.marker = marker;
	    }
	    collect(rtcList) {
	        return __awaiter(this, void 0, void 0, function* () {
	            const statsList = yield Promise.all(rtcList.map((observerPc) => __awaiter(this, void 0, void 0, function* () { return this.collectStats(observerPc); })));
	            return statsList;
	        });
	    }
	    collectUserMediaError(errName) {
	        return __awaiter(this, void 0, void 0, function* () {
	            return {
	                'details': {
	                    'browserId': yield observerSingleton.getBrowserId(),
	                    'clientDetails': BrowserUtil.getClientDetails(),
	                    'deviceList': yield BrowserUtil.getDeviceList(),
	                    'marker': this.marker,
	                    'timeZoneOffsetInMinute': TimeUtil.getTimeZoneOffsetInMinute(),
	                    'timestamp': TimeUtil.getCurrent()
	                },
	                errName
	            };
	        });
	    }
	    collectStats(observerPc) {
	        return __awaiter(this, void 0, void 0, function* () {
	            const stats = yield observerPc.getStats();
	            const pcDetails = observerPc.getPcDetails(this.marker);
	            return {
	                'details': pcDetails,
	                stats
	            };
	        });
	    }
	}

	class Observer {
	    constructor(_initializeConfig) {
	        this._initializeConfig = _initializeConfig;
	        this._userMediaHandler = new UserMediaHandler();
	        this._rtcList = [];
	        this._collector = new RTCCollector();
	        this._collectorWorker = new CollectorWorker(
	        // @ts-expect-error Will be injected in build time
	        "https://observertc.github.io/observer-js/dist/latest/observer.worker.js", this);
	        this.addPC = this.addPC.bind(this);
	        this.removePC = this.removePC.bind(this);
	        this.setIntegration = this.setIntegration.bind(this);
	        this.setLocalTransport = this.setLocalTransport.bind(this);
	        this._collectorWorker.loadWorker();
	        this._userMediaHandler.overrideUserMedia(this);
	        // eslint-disable-next-line no-console
	        console.warn('$ObserverRTC version[collector]', 
	        // @ts-expect-error Will be injected in build time
	        "2103-27", 'from build date', 
	        // @ts-expect-error Will be injected in build time
	        "Sat, 27 Mar 2021 12:52:48 GMT");
	    }
	    onError(_err) {
	        // Pass
	        logger.warn(_err);
	    }
	    onMediaError(errName) {
	        this._collector.collectUserMediaError(errName).then((mediaError) => {
	            this._collectorWorker.sendUserMediaError(mediaError);
	        }).catch(null);
	    }
	    onRequestRawStats() {
	        // Before collecting stats, check if those pc are active
	        this._rtcList = this._rtcList.filter((pc) => {
	            // Update connection state
	            pc.updateConnectionState();
	            return !pc.isExpired;
	        });
	        // Now collect stats for all active peer connections
	        this._collector.collect(this._rtcList).then((rawStats) => {
	            this._collectorWorker.sendRawStats(rawStats);
	        }).catch(null);
	    }
	    onRequestInitialConfig() {
	        this._collectorWorker.sendInitialConfig(Object.assign(Object.assign({}, this._initializeConfig), this._localTransport && { 'transportType': 'local' }));
	    }
	    onTransportCallback(peerConnectionSamples) {
	        var _a, _b;
	        (_b = (_a = this._localTransport) === null || _a === void 0 ? void 0 : _a.onObserverRTCSample) === null || _b === void 0 ? void 0 : _b.call(_a, peerConnectionSamples);
	    }
	    setIntegration(integration) {
	        this._integration = integration;
	    }
	    setLocalTransport(transport) {
	        this._localTransport = transport;
	    }
	    updateMarker(marker) {
	        this._collector.updateMarker(marker);
	    }
	    addPC(pc, callId, userId) {
	        const userConfig = {
	            callId,
	            'integration': this._integration,
	            pc,
	            userId
	        };
	        logger.warn('adding pc', userConfig);
	        this._rtcList.push(new ObserverPC(userConfig));
	    }
	    removePC(pc) {
	        this._rtcList = this._rtcList.filter((value) => value.id !== pc.id);
	    }
	    get rtcList() {
	        return this._rtcList;
	    }
	    dispose() {
	        this._rtcList = [];
	    }
	}

	class Builder {
	    constructor(initializeConfig) {
	        this.instance = new Observer(initializeConfig);
	    }
	    withLocalTransport(transport) {
	        this.instance.setLocalTransport(transport);
	        return this;
	    }
	    withIntegration(integration) {
	        this.instance.setIntegration(integration);
	        return this;
	    }
	    withMarker(marker) {
	        this.instance.updateMarker(marker);
	        return this;
	    }
	    build() {
	        return this.instance;
	    }
	}

	exports.Builder = Builder;
	exports.Observer = Observer;
	exports.ObserverPC = ObserverPC;
	exports.ParserUtil = ParserUtil;
	exports.logger = logger;

	Object.defineProperty(exports, '__esModule', { value: true });

})));
